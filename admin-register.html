<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Usuarios - VET360 Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/style.css">
</head>
<body class="d-flex align-items-center justify-content-center vh-100">

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <div class="card p-4">
                <div class="card-body">
                    <div class="text-center mb-4">
                        <img src="./assets/imagenes/logovet360opcion 1.jpg" alt="VET360 Logo" class="logo-img">
                        <h1 class="logo">VET360 üêæ</h1>
                        <h2>Registro de Nuevos Usuarios</h2>
                        <p class="text-muted">Solo administradores y personal de IT</p>
                    </div>
                    
                    <div id="error-message" class="alert alert-danger d-none" role="alert"></div>
                    <div id="success-message" class="alert alert-success d-none" role="alert"></div>
                    <div id="access-denied" class="alert alert-warning d-none" role="alert">
                        ‚ö†Ô∏è Acceso denegado. Solo administradores pueden crear usuarios.
                        <br><a href="login.html" class="btn btn-sm btn-primary mt-2">Volver al Login</a>
                    </div>
                    
                    <form id="admin-register-form" class="d-none">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="firstName" class="form-label">Nombre</label>
                                    <input type="text" class="form-control" id="firstName" name="firstName" required>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="lastName" class="form-label">Apellido</label>
                                    <input type="text" class="form-control" id="lastName" name="lastName" required>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="email" class="form-label">Correo electr√≥nico</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="password" class="form-label">Contrase√±a temporal</label>
                            <input type="password" class="form-control" id="password" name="password" required minlength="8">
                            <div class="form-text">M√≠nimo 8 caracteres. El usuario deber√° cambiarla en el primer login.</div>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="role" class="form-label">Rol del Usuario</label>
                            <select class="form-select" id="role" name="role" required>
                                <option value="">Seleccionar rol...</option>
                                <option value="veterinario">Veterinario</option>
                                <option value="asistente">Asistente Veterinario</option>
                                <option value="recepcionista">Recepcionista</option>
                                <option value="admin">Administrador</option>
                                <option value="it_support">Soporte IT</option>
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="department" class="form-label">Departamento</label>
                            <select class="form-select" id="department" name="department" required>
                                <option value="">Seleccionar departamento...</option>
                                <option value="clinica">Cl√≠nica General</option>
                                <option value="cirugia">Cirug√≠a</option>
                                <option value="emergencias">Emergencias</option>
                                <option value="administracion">Administraci√≥n</option>
                                <option value="it">Tecnolog√≠a</option>
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="employeeId" class="form-label">ID de Empleado</label>
                            <input type="text" class="form-control" id="employeeId" name="employeeId" required>
                            <div class="form-text">Identificador √∫nico del empleado en el sistema.</div>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="requirePasswordChange">
                            <label class="form-check-label" for="requirePasswordChange">
                                Requerir cambio de contrase√±a en el primer login
                            </label>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="register-btn">
                                <span class="btn-text">Crear Usuario</span>
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            </button>
                            <a href="dashboard.html" class="btn btn-secondary">Volver al Dashboard</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Firebase SDK v12 (modular) -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js';
    import { getDatabase, ref, set, get } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js';

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBZoyZqhODCH90zcPdY_iT8mhh2S-X5FRE",
        authDomain: "vet360-d262a.firebaseapp.com",
        databaseURL: "https://vet360-d262a-default-rtdb.firebaseio.com",
        projectId: "vet360-d262a",
        storageBucket: "vet360-d262a.firebasestorage.app",
        messagingSenderId: "184009559961",
        appId: "1:184009559961:web:12b1311b6224a5d58ecd08",
        measurementId: "G-5K02J1Z7VZ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // UI elements
    const registerForm = document.getElementById('admin-register-form');
    const accessDenied = document.getElementById('access-denied');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');
    const registerBtn = document.getElementById('register-btn');

    // Check if current user has admin privileges
    async function checkAdminAccess(user) {
        try {
            const userRef = ref(db, `users/${user.uid}`);
            const snapshot = await get(userRef);
            if (snapshot.exists()) {
                const userData = snapshot.val();
                return userData.role === 'admin' || userData.role === 'it_support';
            }
            return false;
        } catch (error) {
            console.error('Error checking admin access:', error);
            return false;
        }
    }

    // Show/hide UI elements
    function showElement(element) {
        element.classList.remove('d-none');
    }

    function hideElement(element) {
        element.classList.add('d-none');
    }

    // Show loading state
    function showLoading(show) {
        const btnText = registerBtn.querySelector('.btn-text');
        const spinner = registerBtn.querySelector('.spinner-border');
        
        if (show) {
            btnText.textContent = 'Creando Usuario...';
            spinner.classList.remove('d-none');
            registerBtn.disabled = true;
        } else {
            btnText.textContent = 'Crear Usuario';
            spinner.classList.add('d-none');
            registerBtn.disabled = false;
        }
    }

    // Show messages
    function showError(message) {
        errorMessage.textContent = message;
        showElement(errorMessage);
        hideElement(successMessage);
    }

    function showSuccess(message) {
        successMessage.textContent = message;
        showElement(successMessage);
        hideElement(errorMessage);
    }

    function hideMessages() {
        hideElement(errorMessage);
        hideElement(successMessage);
    }

    // Create user with role and profile
    async function createUserWithRole(userData) {
        showLoading(true);
        hideMessages();

        try {
            // Create Firebase Auth user
            const userCredential = await createUserWithEmailAndPassword(auth, userData.email, userData.password);
            const user = userCredential.user;

            // Create user profile in Firestore
            const userProfile = {
                uid: user.uid,
                email: userData.email,
                firstName: userData.firstName,
                lastName: userData.lastName,
                role: userData.role,
                department: userData.department,
                employeeId: userData.employeeId,
                createdAt: new Date().toISOString(),
                requirePasswordChange: userData.requirePasswordChange || false,
                isActive: true,
                permissions: getRolePermissions(userData.role)
            };

            // Save to Realtime Database
            await set(ref(db, `users/${user.uid}`), userProfile);

            showSuccess(`‚úÖ Usuario ${userData.firstName} ${userData.lastName} creado exitosamente.`);
            
            // Clear form
            registerForm.reset();
            
            // Sign out the newly created user to prevent auto-login
            await signOut(auth);

        } catch (error) {
            console.error('Error creating user:', error);
            showError(getErrorMessage(error.code));
        } finally {
            showLoading(false);
        }
    }

    // Get role-based permissions
    function getRolePermissions(role) {
        const permissions = {
            veterinario: ['view_patients', 'create_patients', 'edit_patients', 'view_appointments', 'create_appointments', 'view_medical_records', 'create_medical_records'],
            asistente: ['view_patients', 'edit_patients', 'view_appointments', 'create_appointments', 'view_medical_records'],
            recepcionista: ['view_patients', 'create_patients', 'view_appointments', 'create_appointments', 'manage_billing'],
            admin: ['full_access', 'manage_users', 'view_reports', 'system_settings'],
            it_support: ['full_access', 'manage_users', 'system_maintenance', 'backup_restore']
        };
        
        return permissions[role] || [];
    }

    // Get user-friendly error messages
    function getErrorMessage(errorCode) {
        switch (errorCode) {
            case 'auth/email-already-in-use':
                return '‚ùå Este correo ya est√° registrado en el sistema.';
            case 'auth/invalid-email':
                return '‚ùå El formato del correo electr√≥nico es incorrecto.';
            case 'auth/weak-password':
                return '‚ùå La contrase√±a debe tener al menos 8 caracteres.';
            case 'auth/network-request-failed':
                return 'üåê Error de conexi√≥n. Verifica tu internet.';
            default:
                return `üö® Error: ${errorCode}. Contacta al soporte t√©cnico.`;
        }
    }

    // Form validation
    function validateForm() {
        const formData = new FormData(registerForm);
        const inputs = registerForm.querySelectorAll('input, select');
        let isValid = true;

        inputs.forEach(input => {
            input.classList.remove('is-invalid');
            
            if (!input.value.trim()) {
                input.classList.add('is-invalid');
                input.nextElementSibling.textContent = 'Este campo es requerido';
                isValid = false;
            }
        });

        // Additional validations
        const email = formData.get('email');
        const password = formData.get('password');
        const employeeId = formData.get('employeeId');

        if (email && !email.includes('@')) {
            document.getElementById('email').classList.add('is-invalid');
            isValid = false;
        }

        if (password && password.length < 8) {
            document.getElementById('password').classList.add('is-invalid');
            isValid = false;
        }

        return isValid;
    }

    // Event listeners
    registerForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!validateForm()) {
            showError('‚ö†Ô∏è Por favor, completa todos los campos correctamente.');
            return;
        }

        const formData = new FormData(registerForm);
        const userData = {
            firstName: formData.get('firstName'),
            lastName: formData.get('lastName'),
            email: formData.get('email'),
            password: formData.get('password'),
            role: formData.get('role'),
            department: formData.get('department'),
            employeeId: formData.get('employeeId'),
            requirePasswordChange: document.getElementById('requirePasswordChange').checked
        };

        createUserWithRole(userData);
    });

    // Clear validation on input
    registerForm.addEventListener('input', function(e) {
        if (e.target.matches('input, select')) {
            e.target.classList.remove('is-invalid');
            hideMessages();
        }
    });

    // Auth state observer
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // Check if user has admin access
            const hasAccess = await checkAdminAccess(user);
            if (hasAccess) {
                showElement(registerForm);
                hideElement(accessDenied);
            } else {
                hideElement(registerForm);
                showElement(accessDenied);
            }
        } else {
            // Not logged in, redirect to login
            window.location.href = 'login.html';
        }
    });
</script>

</body>
</html>