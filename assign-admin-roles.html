<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asignar Roles de Administrador - VET360</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/style.css">
</head>
<body class="d-flex align-items-center justify-content-center vh-100">

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <div class="card p-4">
                <div class="card-body">
                    <div class="text-center mb-4">
                        <img src="./assets/imagenes/logovet360opcion 1.jpg" alt="VET360 Logo" class="logo-img">
                        <h1 class="logo">VET360 üêæ</h1>
                        <h2>Asignar Roles de Administrador</h2>
                        <p class="text-muted">Configura los roles para usuarios ya registrados en Firebase</p>
                    </div>
                    
                    <div id="error-message" class="alert alert-danger d-none" role="alert"></div>
                    <div id="success-message" class="alert alert-success d-none" role="alert"></div>
                    <div id="info-message" class="alert alert-info" role="alert">
                        üîß Esta p√°gina asigna roles de administrador a usuarios que ya est√°n en Firebase Authentication.
                    </div>
                    
                    <!-- Usuario 1 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>üë§ Usuario 1</h5>
                        </div>
                        <div class="card-body">
                            <form id="user1-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="email1" class="form-label">Correo Electr√≥nico</label>
                                        <input type="email" class="form-control" id="email1" value="mperdomo591@gmail.com" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="password1" class="form-label">Contrase√±a (para validar)</label>
                                        <input type="password" class="form-control" id="password1" placeholder="Ingresa la contrase√±a" required>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <label for="firstName1" class="form-label">Nombre</label>
                                        <input type="text" class="form-control" id="firstName1" value="Michel" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="lastName1" class="form-label">Apellido</label>
                                        <input type="text" class="form-control" id="lastName1" value="Perdomo" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="employeeId1" class="form-label">ID Empleado</label>
                                        <input type="text" class="form-control" id="employeeId1" value="VET360-ADMIN-001" required>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <label for="role1" class="form-label">Rol</label>
                                        <select class="form-select" id="role1" required>
                                            <option value="admin" selected>üëë Administrador</option>
                                            <option value="it_support">üîß Soporte IT</option>
                                            <option value="veterinario">ü©∫ Veterinario</option>
                                            <option value="recepcionista">üìã Recepcionista</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="department1" class="form-label">Departamento</label>
                                        <select class="form-select" id="department1" required>
                                            <option value="administracion" selected>Administraci√≥n</option>
                                            <option value="it">IT</option>
                                            <option value="clinica">Cl√≠nica</option>
                                            <option value="cirugia">Cirug√≠a</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="d-grid mt-3">
                                    <button type="submit" class="btn btn-primary" id="assign1-btn">
                                        <span class="btn-text">Asignar Rol de Admin</span>
                                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Usuario 2 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>üë§ Usuario 2</h5>
                        </div>
                        <div class="card-body">
                            <form id="user2-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="email2" class="form-label">Correo Electr√≥nico</label>
                                        <input type="email" class="form-control" id="email2" value="10luisdominguez@gmail.com" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="password2" class="form-label">Contrase√±a (para validar)</label>
                                        <input type="password" class="form-control" id="password2" placeholder="Ingresa la contrase√±a" required>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <label for="firstName2" class="form-label">Nombre</label>
                                        <input type="text" class="form-control" id="firstName2" value="Luis" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="lastName2" class="form-label">Apellido</label>
                                        <input type="text" class="form-control" id="lastName2" value="Dom√≠nguez" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="employeeId2" class="form-label">ID Empleado</label>
                                        <input type="text" class="form-control" id="employeeId2" value="VET360-ADMIN-002" required>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <label for="role2" class="form-label">Rol</label>
                                        <select class="form-select" id="role2" required>
                                            <option value="admin" selected>üëë Administrador</option>
                                            <option value="it_support">üîß Soporte IT</option>
                                            <option value="veterinario">ü©∫ Veterinario</option>
                                            <option value="recepcionista">üìã Recepcionista</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="department2" class="form-label">Departamento</label>
                                        <select class="form-select" id="department2" required>
                                            <option value="administracion" selected>Administraci√≥n</option>
                                            <option value="it">IT</option>
                                            <option value="clinica">Cl√≠nica</option>
                                            <option value="cirugia">Cirug√≠a</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="d-grid mt-3">
                                    <button type="submit" class="btn btn-primary" id="assign2-btn">
                                        <span class="btn-text">Asignar Rol de Admin</span>
                                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div id="success-panel" class="d-none mt-4">
                        <div class="alert alert-success">
                            <h5>‚úÖ ¬°Configuraci√≥n completada!</h5>
                            <p>Los roles de administrador han sido asignados exitosamente.</p>
                            <hr>
                            <p class="mb-0">
                                <strong>Pr√≥ximos pasos:</strong>
                                <br>1. Ir a la p√°gina de <a href="login.html" class="btn btn-sm btn-primary">Login</a>
                                <br>2. Iniciar sesi√≥n con cualquiera de las cuentas configuradas
                                <br>3. Acceder al dashboard de administrador
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Firebase SDK v12 (modular) -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js';
    import { getDatabase, ref, set, get } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js';

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBZoyZqhODCH90zcPdY_iT8mhh2S-X5FRE",
        authDomain: "vet360-d262a.firebaseapp.com",
        databaseURL: "https://vet360-d262a-default-rtdb.firebaseio.com",
        projectId: "vet360-d262a",
        storageBucket: "vet360-d262a.firebasestorage.app",
        messagingSenderId: "184009559961",
        appId: "1:184009559961:web:12b1311b6224a5d58ecd08",
        measurementId: "G-5K02J1Z7VZ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // UI elements
    const user1Form = document.getElementById('user1-form');
    const user2Form = document.getElementById('user2-form');
    const assign1Btn = document.getElementById('assign1-btn');
    const assign2Btn = document.getElementById('assign2-btn');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');
    const infoMessage = document.getElementById('info-message');
    const successPanel = document.getElementById('success-panel');

    let completedUsers = 0;

    // Admin permissions (full access)
    const ADMIN_PERMISSIONS = [
        'full_access',
        'manage_users',
        'create_users',
        'edit_users',
        'delete_users',
        'view_reports',
        'system_settings',
        'manage_billing',
        'view_patients',
        'create_patients',
        'edit_patients',
        'delete_patients',
        'view_appointments',
        'create_appointments',
        'edit_appointments',
        'delete_appointments',
        'view_medical_records',
        'create_medical_records',
        'edit_medical_records'
    ];

    // Show/hide elements
    function showElement(element) {
        element.classList.remove('d-none');
    }

    function hideElement(element) {
        element.classList.add('d-none');
    }

    // Show loading state
    function showLoading(button, show) {
        const btnText = button.querySelector('.btn-text');
        const spinner = button.querySelector('.spinner-border');
        
        if (show) {
            btnText.textContent = 'Asignando rol...';
            showElement(spinner);
            button.disabled = true;
        } else {
            btnText.textContent = 'Asignar Rol de Admin';
            hideElement(spinner);
            button.disabled = false;
        }
    }

    // Show messages
    function showError(message) {
        errorMessage.textContent = message;
        showElement(errorMessage);
        hideElement(successMessage);
    }

    function showSuccess(message) {
        successMessage.textContent = message;
        showElement(successMessage);
        hideElement(errorMessage);
    }

    function hideMessages() {
        hideElement(errorMessage);
        hideElement(successMessage);
    }

    // Assign admin role to user
    async function assignAdminRole(userData, button) {
        showLoading(button, true);
        hideMessages();

        try {
            console.log('Attempting to assign role for:', userData.email);
            
            // First, authenticate with the user credentials to get their UID
            const userCredential = await signInWithEmailAndPassword(auth, userData.email, userData.password);
            const user = userCredential.user;
            
            console.log('User authenticated successfully, UID:', user.uid);
            
            // Check if user profile already exists
            const userRef = ref(db, `users/${user.uid}`);
            const existingSnapshot = await get(userRef);
            if (existingSnapshot.exists()) {
                console.log('User profile already exists, updating...');
            } else {
                console.log('Creating new user profile...');
            }
            
            // Create admin profile in Realtime Database
            const adminProfile = {
                uid: user.uid,
                email: userData.email,
                firstName: userData.firstName,
                lastName: userData.lastName,
                role: userData.role,
                department: userData.department,
                employeeId: userData.employeeId,
                createdAt: existingSnapshot.exists() ? existingSnapshot.val().createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                requirePasswordChange: false,
                isActive: true,
                permissions: userData.role === 'admin' ? ADMIN_PERMISSIONS : [],
                isConfigured: true,
                lastLogin: new Date().toISOString(),
                profileCompleted: true
            };

            console.log('Saving profile to Realtime Database...');
            // Save to Realtime Database
            await set(userRef, adminProfile);
            
            console.log('Profile saved successfully');

            // Sign out immediately to allow next user
            await signOut(auth);
            console.log('User signed out');

            showSuccess(`‚úÖ Rol asignado exitosamente a ${userData.firstName} ${userData.lastName}`);
            
            completedUsers++;
            if (completedUsers >= 2) {
                setTimeout(() => {
                    hideElement(user1Form.parentElement);
                    hideElement(user2Form.parentElement);
                    hideElement(infoMessage);
                    showElement(successPanel);
                }, 2000);
            }

        } catch (error) {
            console.error('Detailed error:', error);
            console.error('Error code:', error.code);
            console.error('Error message:', error.message);
            
            let errorMsg = 'üö® Error desconocido. Contacta al soporte t√©cnico.';
            
            switch (error.code) {
                case 'auth/user-not-found':
                    errorMsg = '‚ùå Usuario no encontrado en Firebase Authentication. ¬øEst√° registrado el correo?';
                    break;
                case 'auth/wrong-password':
                    errorMsg = '‚ùå Contrase√±a incorrecta. Verifica la contrase√±a del usuario.';
                    break;
                case 'auth/invalid-email':
                    errorMsg = '‚ùå El formato del correo electr√≥nico es incorrecto.';
                    break;
                case 'auth/network-request-failed':
                    errorMsg = 'üåê Error de conexi√≥n. Verifica tu internet.';
                    break;
                case 'auth/too-many-requests':
                    errorMsg = '‚ö†Ô∏è Demasiados intentos fallidos. Espera unos minutos.';
                    break;
                case 'auth/invalid-credential':
                    errorMsg = '‚ùå Credenciales inv√°lidas. Verifica correo y contrase√±a.';
                    break;
                case 'permission-denied':
                    errorMsg = 'üö´ Error de permisos en Realtime Database. Verifica la configuraci√≥n de la base de datos.';
                    break;
                case 'unavailable':
                    errorMsg = 'üì° Realtime Database no est√° disponible. Intenta m√°s tarde.';
                    break;
                default:
                    errorMsg = `üö® Error espec√≠fico: ${error.code} - ${error.message}`;
                    break;
            }
            
            showError(errorMsg);
        } finally {
            showLoading(button, false);
        }
    }

    // User 1 form submission
    user1Form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const userData = {
            email: document.getElementById('email1').value.trim(),
            password: document.getElementById('password1').value,
            firstName: document.getElementById('firstName1').value.trim(),
            lastName: document.getElementById('lastName1').value.trim(),
            employeeId: document.getElementById('employeeId1').value.trim(),
            role: document.getElementById('role1').value,
            department: document.getElementById('department1').value
        };

        assignAdminRole(userData, assign1Btn);
    });

    // User 2 form submission
    user2Form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const userData = {
            email: document.getElementById('email2').value.trim(),
            password: document.getElementById('password2').value,
            firstName: document.getElementById('firstName2').value.trim(),
            lastName: document.getElementById('lastName2').value.trim(),
            employeeId: document.getElementById('employeeId2').value.trim(),
            role: document.getElementById('role2').value,
            department: document.getElementById('department2').value
        };

        assignAdminRole(userData, assign2Btn);
    });
</script>

</body>
</html>