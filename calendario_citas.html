<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario de Citas - VET360</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/style.css"> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>

<div id="navbar-container"></div>

<div class="container mt-5 mb-5">
    <div class="card container-bg p-4 p-md-5">
        <h2 class="mb-4 text-center">Calendario de Citas Programadas üóìÔ∏è</h2>
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <button class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Anterior</button>
            <h4 class="mb-0">Todas las Citas Programadas</h4>
            <button class="btn btn-outline-secondary">Siguiente <i class="bi bi-arrow-right"></i></button>
        </div>

        <div class="text-end mb-4">
            <a href="agendar_cita.html" class="btn btn-success"><i class="bi bi-plus-circle"></i> Agendar Nueva Cita</a>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th scope="col">Fecha</th>
                        <th scope="col">Hora</th>
                        <th scope="col">Cliente/Mascota</th>
                        <th scope="col">Servicio</th>
                        <th scope="col">Veterinario</th>
                        <th scope="col">Acciones</th>
                    </tr>
                </thead>
                <tbody id="appointments-table-body">
                    </tbody>
            </table>
        </div>
        
        <p id="loading-message" class="text-center text-muted">Cargando citas...</p>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="vetToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="4000">
        <div class="toast-header">
            <span class="me-2 fs-5" id="toastIcon">üêæ</span> 
            <strong class="me-auto text-dark" id="toastTitle">VET360 - Mensaje</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastBody">Mensaje de prueba.</div>
    </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">Detalles de la Cita</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="detailsModalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmDeleteModalLabel"><i class="bi bi-exclamation-triangle-fill"></i> Confirmar Cancelaci√≥n</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¬øEst√°s seguro de que deseas cancelar esta cita? Esta acci√≥n no se puede deshacer.</p>
                <input type="hidden" id="appointmentIdToDelete"> 
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, Mantener</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">S√≠, Cancelar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> 


<script>
    // Tu configuraci√≥n de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBZoyZqhODCH90zcPdY_iT8mhh2S-X5FRE",
        authDomain: "vet360-d262a.firebaseapp.com",
        databaseURL: "https://vet360-d262a-default-rtdb.firebaseio.com",
        projectId: "vet360-d262a",
        storageBucket: "vet360-d262a.firebasestorage.app",
        messagingSenderId: "184009559961",
        appId: "1:184009559961:web:12b1311b6224a5d58ecd08",
        measurementId: "G-5K02J1Z7VZ"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let deleteModalInstance;
    let detailsModalInstance;
    let vetToastInstance;
    
    // --- L√≥gica del Toast ---
    function showVetToast(title, body, icon='üêæ', colorClass='text-dark') {
        const vetToastEl = document.getElementById('vetToast');
        
        if (!vetToastInstance) {
            vetToastInstance = new bootstrap.Toast(vetToastEl);
        }

        const toastHeader = vetToastEl.querySelector('.toast-header');
        // Limpia y aplica la clase de color para el fondo/texto
        toastHeader.className = 'toast-header'; 
        if (colorClass.includes('bg-')) {
             toastHeader.classList.add(colorClass);
             toastHeader.classList.add('text-white'); 
        } else {
             toastHeader.classList.add('bg-light'); 
        }

        document.getElementById('toastTitle').textContent = title;
        document.getElementById('toastIcon').textContent = icon;
        document.getElementById('toastBody').textContent = body;
        vetToastInstance.show();
    }
    
    // --- Cargar citas desde Firebase ---
    function loadAppointments() {
        const tbody = document.getElementById('appointments-table-body');
        const loadingMessage = document.getElementById('loading-message');
        tbody.innerHTML = '';
        loadingMessage.style.display = 'block';

        database.ref('appointments').once('value')
            .then(snapshot => {
                loadingMessage.style.display = 'none';

                if (!snapshot.exists()) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4">No hay citas programadas.</td></tr>';
                    return;
                }

                let appointmentsArray = [];

                // Recorre las citas y guarda el ID (clave de Firebase)
                snapshot.forEach(childSnapshot => {
                    const appointment = childSnapshot.val();
                    appointment.id = childSnapshot.key; // üëà CRUCIAL: Captura el ID
                    appointmentsArray.push(appointment);
                });

                // Ordenar por fecha y hora
                appointmentsArray.sort((a, b) => {
                    const dateA = new Date(`${a.date} ${a.time}`);
                    const dateB = new Date(`${b.date} ${b.time}`);
                    return dateA - dateB;
                });

                // Renderizar las filas de la tabla
                appointmentsArray.forEach(app => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = app.date;
                    row.insertCell().textContent = app.time;
                    row.insertCell().textContent = `${app.client} / ${app.pet}`;
                    row.insertCell().textContent = app.service;
                    row.insertCell().textContent = app.vet;

                    const actionsCell = row.insertCell();
                    actionsCell.innerHTML = `
                        <button class="btn btn-sm btn-info text-white me-1" title="Ver Detalles" onclick="showDetails('${app.id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" title="Cancelar Cita" onclick="initiateDelete('${app.id}')">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    `;
                });
            })
            .catch(error => {
                loadingMessage.style.display = 'none';
                console.error("Firebase Error al cargar citas:", error);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-danger">Error: No se pudieron cargar las citas. Revisa la consola.</td></tr>';
                showVetToast('Error de Carga', 'No se pudieron cargar las citas. Revisa tus reglas de lectura.', '‚ùå', 'bg-danger');
            });
    }

    // --- Mostrar detalles de una cita ---
    window.showDetails = function(id) {
        database.ref('appointments/' + id).once('value')
            .then(snapshot => {
                const app = snapshot.val();
                if (!app) {
                    return showVetToast("Detalles no encontrados.", "La cita puede haber sido eliminada.", '‚ö†Ô∏è', 'bg-warning');
                }

                document.getElementById('detailsModalBody').innerHTML = `
                    <p><strong>Cliente:</strong> ${app.client}</p>
                    <p><strong>Mascota:</strong> ${app.pet}</p>
                    <p><strong>Fecha:</strong> ${app.date}</p>
                    <p><strong>Hora:</strong> ${app.time}</p>
                    <p><strong>Servicio:</strong> ${app.service}</p>
                    <p><strong>Veterinario:</strong> ${app.vet}</p>
                    <p><strong>Notas:</strong> ${app.notes || 'N/A'}</p>
                `;
                detailsModalInstance.show();
            });
    };

    // --- Iniciar eliminaci√≥n de cita (guarda el ID) ---
    window.initiateDelete = function(id) {
        document.getElementById('appointmentIdToDelete').value = id; // üëà Guarda el ID en el campo oculto
        deleteModalInstance.show();
    };

    // --- Ejecutar eliminaci√≥n de cita (lee el ID y borra) ---
    function executeDelete() {
        // Lee el ID del campo oculto
        const idToDelete = document.getElementById('appointmentIdToDelete').value;
        
        if (!idToDelete) {
             console.error("Error: ID de cita no encontrado para eliminar.");
             deleteModalInstance.hide();
             showVetToast("Error Interno", "No se pudo identificar la cita a cancelar.", '‚ùå', 'bg-danger');
             return;
        }

        // üõë L√ìGICA DE BORRADO DE FIREBASE üõë
        database.ref('appointments/' + idToDelete).remove()
            .then(() => {
                // √âXITO: Muestra Toast verde
                showVetToast("¬°Cancelada!", "Cita cancelada correctamente.", 'üóëÔ∏è', 'bg-success');
                deleteModalInstance.hide();
                loadAppointments(); // Recarga la tabla para reflejar el cambio
            })
            .catch(error => {
                 deleteModalInstance.hide();
                 console.error("Firebase Error al eliminar cita:", error);
                 // ERROR: Muestra Toast rojo y verifica si es un error de permiso
                 if (error.code === 'PERMISSION_DENIED') {
                      showVetToast("Acceso Denegado", "Debes iniciar sesi√≥n para cancelar citas.", 'üîí', 'bg-danger');
                 } else {
                      showVetToast("Error al cancelar", "Ocurri√≥ un error. Revisa la consola para m√°s detalles.", '‚ö†Ô∏è', 'bg-danger');
                 }
            });
    }

    // --- Inicializaci√≥n DOM ---
    document.addEventListener('DOMContentLoaded', () => {
        // Inicializar instancias de Bootstrap Modals
        deleteModalInstance = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        detailsModalInstance = new bootstrap.Modal(document.getElementById('detailsModal'));

        // Cargar Navbar (asumiendo que tienes 'navbar.html')
        fetch('navbar.html')
            .then(response => response.text())
            .then(data => document.getElementById('navbar-container').innerHTML = data);
        
        // Asignar el listener al bot√≥n de confirmar cancelaci√≥n
        document.getElementById('confirmDeleteButton').addEventListener('click', executeDelete);

        // Cargar las citas al inicio
        loadAppointments();
    });
</script>
</body>
</html>