<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Completar Perfil - VET360</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/style.css">
</head>
<body class="d-flex align-items-center justify-content-center vh-100">

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8">
            <div class="card p-4">
                <div class="card-body">
                    <div class="text-center mb-4">
                        <img src="./assets/imagenes/logovet360opcion 1.jpg" alt="VET360 Logo" class="logo-img">
                        <h1 class="logo">VET360 üêæ</h1>
                        <h2>Completar Perfil</h2>
                        <p class="text-muted">Configurar perfiles faltantes</p>
                    </div>
                    
                    <div id="error-message" class="alert alert-danger d-none" role="alert"></div>
                    <div id="success-message" class="alert alert-success d-none" role="alert"></div>
                    <div id="info-message" class="alert alert-info" role="alert">
                        üîß Esta p√°gina completa perfiles de usuarios que est√°n en Authentication pero no en Database.
                    </div>
                    
                    <form id="complete-profile-form">
                        <h5>üë§ Datos del Usuario</h5>
                        
                        <div class="mb-3">
                            <label for="email" class="form-label">Correo Electr√≥nico</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="password" class="form-label">Contrase√±a (para validar)</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label for="firstName" class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="firstName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="lastName" class="form-label">Apellido</label>
                                <input type="text" class="form-control" id="lastName" required>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label for="role" class="form-label">Rol</label>
                                <select class="form-select" id="role" required>
                                    <option value="">Seleccionar rol...</option>
                                    <option value="admin">üëë Administrador</option>
                                    <option value="it_support">üîß Soporte IT</option>
                                    <option value="veterinario">ü©∫ Veterinario</option>
                                    <option value="recepcionista">üìã Recepcionista</option>
                                    <option value="asistente">ü§ù Asistente</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="employeeId" class="form-label">ID Empleado</label>
                                <input type="text" class="form-control" id="employeeId" placeholder="VET360-XXX-000" required>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning mt-3">
                            ‚ö†Ô∏è <strong>Importante:</strong> Este usuario debe existir en Firebase Authentication.
                        </div>
                        
                        <div class="d-grid mt-3">
                            <button type="submit" class="btn btn-primary btn-lg" id="complete-btn">
                                <span class="btn-text">Completar Perfil</span>
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            </button>
                        </div>
                    </form>
                    
                    <div id="success-panel" class="d-none mt-4">
                        <div class="alert alert-success">
                            <h5>‚úÖ ¬°Perfil completado!</h5>
                            <p>El perfil del usuario ha sido creado exitosamente.</p>
                            <hr>
                            <p class="mb-0">
                                <strong>El usuario ya puede:</strong>
                                <br>1. Iniciar sesi√≥n en <a href="login.html" class="btn btn-sm btn-primary">Login</a>
                                <br>2. Acceder a sus funcionalidades seg√∫n el rol asignado
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Firebase SDK v12.5.0 (modular) -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js';
    import { getDatabase, ref, set } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js';

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBZoyZqhODCH90zcPdY_iT8mhh2S-X5FRE",
        authDomain: "vet360-d262a.firebaseapp.com",
        databaseURL: "https://vet360-d262a-default-rtdb.firebaseio.com",
        projectId: "vet360-d262a",
        storageBucket: "vet360-d262a.firebasestorage.app",
        messagingSenderId: "184009559961",
        appId: "1:184009559961:web:12b1311b6224a5d58ecd08",
        measurementId: "G-5K02J1Z7VZ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);

    // UI elements
    const completeForm = document.getElementById('complete-profile-form');
    const completeBtn = document.getElementById('complete-btn');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');
    const infoMessage = document.getElementById('info-message');
    const successPanel = document.getElementById('success-panel');

    // Role permissions
    const ROLE_PERMISSIONS = {
        admin: [
            'full_access', 'manage_users', 'create_users', 'edit_users', 'delete_users',
            'view_reports', 'system_settings', 'manage_billing', 'view_patients',
            'create_patients', 'edit_patients', 'delete_patients', 'view_appointments',
            'create_appointments', 'edit_appointments', 'delete_appointments',
            'view_medical_records', 'create_medical_records', 'edit_medical_records'
        ],
        it_support: [
            'full_access', 'manage_users', 'create_users', 'edit_users',
            'system_maintenance', 'backup_restore', 'view_reports', 'system_settings'
        ],
        veterinario: [
            'view_patients', 'create_patients', 'edit_patients', 'view_appointments',
            'create_appointments', 'edit_appointments', 'view_medical_records',
            'create_medical_records', 'edit_medical_records', 'prescribe_medications',
            'view_lab_results'
        ],
        recepcionista: [
            'view_patients', 'create_patients', 'edit_patients', 'view_appointments',
            'create_appointments', 'edit_appointments', 'manage_billing', 'check_in_patients'
        ],
        asistente: [
            'view_patients', 'edit_patients', 'view_appointments', 'create_appointments',
            'edit_appointments', 'view_medical_records', 'assist_procedures'
        ]
    };

    // Show/hide elements
    function showElement(element) {
        element.classList.remove('d-none');
    }

    function hideElement(element) {
        element.classList.add('d-none');
    }

    // Show loading state
    function showLoading(show) {
        const btnText = completeBtn.querySelector('.btn-text');
        const spinner = completeBtn.querySelector('.spinner-border');
        
        if (show) {
            btnText.textContent = 'Completando perfil...';
            showElement(spinner);
            completeBtn.disabled = true;
        } else {
            btnText.textContent = 'Completar Perfil';
            hideElement(spinner);
            completeBtn.disabled = false;
        }
    }

    // Show messages
    function showError(message) {
        errorMessage.textContent = message;
        showElement(errorMessage);
        hideElement(successMessage);
    }

    function showSuccess(message) {
        successMessage.textContent = message;
        showElement(successMessage);
        hideElement(errorMessage);
    }

    function hideMessages() {
        hideElement(errorMessage);
        hideElement(successMessage);
    }

    // Complete user profile
    async function completeUserProfile(userData) {
        showLoading(true);
        hideMessages();

        try {
            console.log('Authenticating user to get UID:', userData.email);
            
            // Authenticate to get the UID
            const userCredential = await signInWithEmailAndPassword(auth, userData.email, userData.password);
            const user = userCredential.user;
            
            console.log('User authenticated, UID:', user.uid);
            
            // Create complete profile
            const userProfile = {
                uid: user.uid,
                email: userData.email,
                firstName: userData.firstName,
                lastName: userData.lastName,
                role: userData.role,
                department: userData.role === 'admin' || userData.role === 'it_support' ? 'administracion' : 'clinica',
                employeeId: userData.employeeId,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                requirePasswordChange: false,
                isActive: true,
                permissions: ROLE_PERMISSIONS[userData.role] || [],
                isConfigured: true,
                profileCompleted: true,
                lastLogin: new Date().toISOString()
            };

            console.log('Saving profile to Realtime Database...');
            
            // Save to Realtime Database
            await set(ref(database, 'users/' + user.uid), userProfile);
            
            console.log('Profile saved successfully');
            
            // Sign out immediately
            await signOut(auth);
            
            showSuccess(`‚úÖ Perfil completado para ${userData.firstName} ${userData.lastName}`);
            
            // Show success panel
            setTimeout(() => {
                hideElement(completeForm);
                hideElement(infoMessage);
                showElement(successPanel);
            }, 2000);

        } catch (error) {
            console.error('Error completing profile:', error);
            
            let errorMsg = 'üö® Error desconocido. Verifica los datos.';
            
            switch (error.code) {
                case 'auth/user-not-found':
                    errorMsg = '‚ùå Usuario no encontrado en Authentication. ¬øEst√° registrado?';
                    break;
                case 'auth/wrong-password':
                    errorMsg = '‚ùå Contrase√±a incorrecta.';
                    break;
                case 'auth/invalid-email':
                    errorMsg = '‚ùå Formato de correo incorrecto.';
                    break;
                case 'PERMISSION_DENIED':
                    errorMsg = 'üö´ Error de permisos en Database. Verifica las reglas.';
                    break;
                default:
                    errorMsg = `üö® Error: ${error.code || error.message}`;
                    break;
            }
            
            showError(errorMsg);
        } finally {
            showLoading(false);
        }
    }

    // Form submission
    completeForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const userData = {
            email: document.getElementById('email').value.trim(),
            password: document.getElementById('password').value,
            firstName: document.getElementById('firstName').value.trim(),
            lastName: document.getElementById('lastName').value.trim(),
            role: document.getElementById('role').value,
            employeeId: document.getElementById('employeeId').value.trim()
        };

        // Basic validation
        if (!userData.email || !userData.password || !userData.firstName || 
            !userData.lastName || !userData.role || !userData.employeeId) {
            showError('‚ùå Todos los campos son requeridos.');
            return;
        }

        if (!userData.email.includes('@')) {
            showError('‚ùå Verifica que el correo sea v√°lido.');
            return;
        }

        if (userData.password.length < 6) {
            showError('‚ùå La contrase√±a debe tener al menos 6 caracteres.');
            return;
        }

        completeUserProfile(userData);
    });
</script>

</body>
</html>