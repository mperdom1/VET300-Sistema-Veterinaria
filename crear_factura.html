<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Factura - VET360</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/style.css"> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<div id="navbar-container"></div>

<div class="container mt-5 mb-5">
    <div class="card container-bg p-4 p-md-5">
        <h2 class="mb-4 text-center">Crear Nueva Factura üìù</h2>
        
        <form id="invoiceForm">
            <div class="row g-3 mb-4 p-3 border rounded">
                <h5 class="mb-3 text-primary"><i class="bi bi-info-circle"></i> Datos de la Factura</h5>

                <div class="col-md-4">
                    <label for="invoiceNum" class="form-label">N√∫mero de Factura</label>
                    <input type="text" class="form-control" id="invoiceNum" value="INV-0000" readonly>
                </div>
                <div class="col-md-4">
                    <label for="invoiceDate" class="form-label">Fecha de Emisi√≥n</label>
                    <input type="date" class="form-control" id="invoiceDate" required>
                </div>
                <div class="col-md-4">
                    <label for="vetSelect" class="form-label">Veterinario a Cargo</label>
                    <select id="vetSelect" class="form-select" required>
                        <option value="" disabled selected>Seleccione un veterinario</option>
                    </select>
                </div>
                
                <div class="col-md-6">
                    <label for="clientName" class="form-label">Cliente (Nombre Completo)</label>
                    <input type="text" class="form-control" id="clientName" placeholder="Juan P√©rez" required>
                </div>
                <div class="col-md-6">
                    <label for="petName" class="form-label">Mascota</label>
                    <input type="text" class="form-control" id="petName" placeholder="Ej: Fido, Pelusa">
                </div>
            </div>

            <div class="mb-4 p-3 border rounded">
                <h5 class="mb-3 text-success"><i class="bi bi-list-task"></i> Servicios</h5>
                
                <div class="row g-3 mb-3 align-items-end">
                    <div class="col-md-6">
                        <label for="serviceSelect" class="form-label">Servicio</label>
                        <select id="serviceSelect" class="form-select" required>
                            <option value="" disabled selected>Seleccione un servicio</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="servicePrice" class="form-label">Precio Unitario ($)</label>
                        <input type="number" class="form-control" id="servicePrice" min="0.01" step="0.01" required>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-success w-100" id="addItemButton"><i class="bi bi-plus-circle"></i> Agregar Item</button>
                    </div>
                </div>

                <div class="table-responsive mt-3">
                    <table class="table table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Servicio</th>
                                <th class="text-end">Precio</th>
                                <th class="text-center">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="invoiceItemsTableBody">
                            </tbody>
                        <tfoot>
                            <tr class="fw-bold">
                                <td colspan="1" class="text-end">TOTAL</td>
                                <td class="text-end" id="invoiceTotal">$0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <div class="col-12 text-end">
                <button type="button" class="btn btn-primary btn-lg" id="saveInvoiceButton">
                    <i class="bi bi-save"></i> Guardar Factura y Generar Preview
                </button>
            </div>
        </form>
        
        <div id="invoicePreviewContainer" class="mt-5" style="display: none;">
            <hr>
            <h3 class="text-center mb-4 text-success">Factura Guardada - Preview para Impresi√≥n</h3>
            
            <div id="pdf-template" class="p-4 border shadow-sm" style="background-color: white;">
                </div>

            <div class="text-center mt-4">
                <button type="button" class="btn btn-danger btn-lg" id="downloadPdfButton">
                    <i class="bi bi-file-earmark-pdf-fill"></i> Descargar PDF e Imprimir
                </button>
            </div>
        </div>

    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="vetToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="4000">
        <div class="toast-header">
            <span class="me-2 fs-5" id="toastIcon">üêæ</span> 
            <strong class="me-auto text-dark" id="toastTitle">VET360 - Mensaje</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastBody">Mensaje de prueba.</div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> 


<script>
    // Tu configuraci√≥n de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBZoyZqhODCH90zcPdY_iT8mhh2S-X5FRE",
        authDomain: "vet360-d262a.firebaseapp.com",
        databaseURL: "https://vet360-d262a-default-rtdb.firebaseio.com",
        projectId: "vet360-d262a",
        storageBucket: "vet360-d262a.firebasestorage.app",
        messagingSenderId: "184009559961",
        appId: "1:184009559961:web:12b1311b6224a5d58ecd08",
        measurementId: "G-5K02J1Z7VZ"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // üí° VERIFICACI√ìN DE SESI√ìN (Recomendado para evitar el error de "Permission Denied")
    firebase.auth().onAuthStateChanged(user => {
        if (!user) {
            console.warn("Usuario no autenticado. Redirigiendo a login (o mostrando mensaje).");
            // **Si tu sistema de login est√° listo, descomenta la siguiente l√≠nea:**
            // window.location.href = 'login.html'; 
            showVetToast("Acceso Denegado", "Debes iniciar sesi√≥n para crear facturas.","üõë", "bg-danger");
        } else {
            console.log("Usuario autenticado:", user.email);
        }
    });
    
    // Variables globales
    const VETS = [
        { name: 'Dr. Alejandro Soto' }, 
        { name: 'Dra. Laura Vega' }, 
        { name: 'T√©c. Karina R√≠os' }
    ];
    // NOTA: 'invoiceItems' debe ser global para que 'buildPdfTemplate' pueda acceder a los datos guardados.
    let invoiceItems = []; 
    let currentInvoiceNumber = 1; 
    let vetToastInstance;
    
    // --- L√≥gica del Toast ---
    function showVetToast(title, body, icon='üêæ', colorClass='text-dark') {
        const vetToastEl = document.getElementById('vetToast');
        
        if (!vetToastInstance) {
            vetToastInstance = new bootstrap.Toast(vetToastEl);
        }

        const toastHeader = vetToastEl.querySelector('.toast-header');
        toastHeader.className = 'toast-header'; 
        if (colorClass.includes('bg-')) {
             toastHeader.classList.add(colorClass);
             toastHeader.classList.add('text-white'); 
        } else {
             toastHeader.classList.add('bg-light'); 
        }

        document.getElementById('toastTitle').textContent = title;
        document.getElementById('toastIcon').textContent = icon;
        document.getElementById('toastBody').textContent = body;
        vetToastInstance.show();
    }


    // --- Inicializaci√≥n y Event Listeners ---
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar fecha
        document.getElementById('invoiceDate').valueAsDate = new Date();
        
        // 1. Cargar Navbar (usando fetch)
        fetch('navbar.html')
            .then(response => response.text())
            .then(data => document.getElementById('navbar-container').innerHTML = data);
            
        // 2. Cargar datos din√°micos
        loadVetsAndServices();
        loadInvoiceNumber(); // Cargar n√∫mero de la factura desde Firebase
        
        // 3. Asignar Eventos
        document.getElementById('addItemButton').addEventListener('click', addItemToInvoice);
        
        // Evento para Guardar y Mostrar Preview
        document.getElementById('saveInvoiceButton').addEventListener('click', function(e) {
            e.preventDefault();
            saveInvoiceAndShowPreview();
        });
        
        // Evento para Descargar PDF (bot√≥n que aparece en el preview)
        document.getElementById('downloadPdfButton').addEventListener('click', downloadPDF);
        
        window.deleteItem = deleteItem;
    });
    
    // --------------------------------------------------------
    // FUNCIONES DE FACTURACI√ìN (√çtems y Totales)
    // --------------------------------------------------------
    
    function loadInvoiceNumber() {
        database.ref('invoiceCounter').once('value')
            .then(snapshot => {
                const lastNum = snapshot.val() || 0;
                currentInvoiceNumber = lastNum + 1;
                document.getElementById('invoiceNum').value = `INV-${String(currentInvoiceNumber).padStart(4, '0')}`;
            })
            .catch(error => {
                console.error("Error al cargar el contador de facturas:", error);
                document.getElementById('invoiceNum').value = `INV-${String(currentInvoiceNumber).padStart(4, '0')}`;
                showVetToast("Error de Contador", "No se pudo obtener el n√∫mero de factura. Usando valor por defecto.", '‚ö†Ô∏è', 'bg-warning');
            });
    }


    function loadVetsAndServices() {
        const vetSelect = document.getElementById('vetSelect');
        VETS.forEach(vet => {
            const option = document.createElement('option');
            option.value = vet.name;
            option.textContent = vet.name;
            vetSelect.appendChild(option);
        });

        // Simulaci√≥n de carga de servicios (usa LocalStorage como fallback)
        const serviceSelect = document.getElementById('serviceSelect');
        const servicesData = JSON.parse(localStorage.getItem('vet360Services')) || [
            { name: 'Consulta General', cost: 40.00 },
            { name: 'Vacunaci√≥n', cost: 50.00 },
            { name: 'Grooming', cost: 35.00 },
        ];
        
        servicesData.forEach(service => {
            const option = document.createElement('option');
            option.value = service.name;
            option.textContent = service.name;
            option.setAttribute('data-cost', service.cost || 0);
            serviceSelect.appendChild(option);
        });
        
        // Evento para auto-llenar el precio al seleccionar un servicio
        serviceSelect.addEventListener('change', function() {
            if (this.selectedIndex > 0) { 
               const selectedOption = this.options[this.selectedIndex];
               const price = selectedOption.getAttribute('data-cost') || 0;
               document.getElementById('servicePrice').value = parseFloat(price).toFixed(2);
            } else {
               document.getElementById('servicePrice').value = '';
            }
        });
    }

    function addItemToInvoice() {
        const serviceSelect = document.getElementById('serviceSelect');
        const priceInput = document.getElementById('servicePrice');
        
        const serviceName = serviceSelect.value;
        const price = parseFloat(priceInput.value);

        if (!serviceName || isNaN(price) || price <= 0) {
            showVetToast("¬°Error!", "Por favor, selecciona un servicio y un precio v√°lido.", '‚ùå', 'bg-danger');
            return;
        }

        const newItem = {
            id: Date.now(), 
            name: serviceName,
            price: price
        };
        
        invoiceItems.push(newItem);
        renderInvoiceItems();
        updateTotal();

        // Limpiar el formulario de item
        serviceSelect.selectedIndex = 0;
        priceInput.value = '';
    }

    function deleteItem(id) {
        invoiceItems = invoiceItems.filter(item => item.id !== id);
        renderInvoiceItems();
        updateTotal();
        showVetToast("Item Eliminado", "Servicio quitado de la factura.", '‚ûñ');
    }

    function renderInvoiceItems() {
        const tbody = document.getElementById('invoiceItemsTableBody');
        tbody.innerHTML = '';

        invoiceItems.forEach(item => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${item.name}</td>
                <td class="text-end">$${item.price.toFixed(2)}</td>
                <td class="text-center">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteItem(${item.id})">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </td>
            `;
        });
    }

    function updateTotal() {
        const total = invoiceItems.reduce((sum, item) => sum + item.price, 0);
        document.getElementById('invoiceTotal').textContent = `$${total.toFixed(2)}`;
        return total;
    }

    // --------------------------------------------------------
    // L√ìGICA DE FIREBASE Y PREVIEW
    // --------------------------------------------------------

    function saveInvoiceAndShowPreview() {
        if (invoiceItems.length === 0) {
            showVetToast("¬°Advertencia!", "No puedes guardar una factura sin servicios agregados.", '‚ö†Ô∏è', 'bg-warning');
            return;
        }
        
        // Validaci√≥n de campos principales del formulario
        if (!document.getElementById('clientName').value || !document.getElementById('vetSelect').value) {
            showVetToast("Datos Faltantes", "Completa el nombre del cliente y el veterinario a cargo.", '‚ùå', 'bg-danger');
            return;
        }

        const invoiceNum = document.getElementById('invoiceNum').value;
        const totalAmount = updateTotal();
        
        // Crear la estructura de datos para Firebase
        const invoiceData = {
            invoiceId: invoiceNum,
            date: document.getElementById('invoiceDate').value,
            client: document.getElementById('clientName').value,
            pet: document.getElementById('petName').value,
            vet: document.getElementById('vetSelect').value,
            // Aqu√≠ guardamos una copia de los √≠tems de la factura
            items: invoiceItems.map(item => ({name: item.name, price: item.price})), 
            total: totalAmount,
            timestamp: Date.now()
        };
        
        const saveButton = document.getElementById('saveInvoiceButton');
        saveButton.disabled = true;
        saveButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...`;

        // 1. Guardar la factura
        database.ref('invoices').push(invoiceData)
            .then(() => {
                // 2. Si el guardado de la factura fue exitoso, actualizamos el contador
                return database.ref('invoiceCounter').set(currentInvoiceNumber);
            })
            .then(() => {
                // 3. Ambas operaciones fueron exitosas.
                showVetToast("¬°Factura Guardada!", `Factura ${invoiceNum} registrada en el historial.`, '‚úÖ', 'bg-success');
                
                // 4. Mostrar el Preview de la factura reci√©n guardada
                buildPdfTemplate(); 
                document.getElementById('invoicePreviewContainer').style.display = 'block';

                // 5. Limpiar el formulario y preparar para la pr√≥xima
                document.getElementById('invoiceForm').reset();
                invoiceItems = []; // Limpiar la lista de √≠tems para la pr√≥xima factura
                renderInvoiceItems();
                updateTotal(); // Esto pondr√° el total en $0.00
                
                // Preparamos el siguiente n√∫mero de factura en la UI
                currentInvoiceNumber++; 
                document.getElementById('invoiceNum').value = `INV-${String(currentInvoiceNumber).padStart(4, '0')}`;
            })
            .catch(error => {
                // Captura el error de PERMISSION_DENIED si el usuario no est√° logueado
                console.error("Error al guardar la factura o actualizar contador:", error);
                showVetToast("Error de Base de Datos", "La factura NO se guard√≥. (Fallo de permisos o red).", 'üö®', 'bg-danger');
            })
            .finally(() => {
                // Reactivar el bot√≥n al finalizar la operaci√≥n
                saveButton.disabled = false;
                saveButton.innerHTML = `<i class="bi bi-save"></i> Guardar Factura y Generar Preview`;
            });
    }

    /**
     * CONSTRUYE EL HTML DE LA FACTURA para mostrarlo en el preview.
     * Utiliza la informaci√≥n que *acaba de ser guardada* en las variables globales.
     */
    function buildPdfTemplate() {
        const template = document.getElementById('pdf-template');
        const totalText = document.getElementById('invoiceTotal').textContent;

        const itemsHtml = invoiceItems.map(item => `
            <tr style="border-bottom: 1px dashed #eee;">
                <td style="padding: 5px 10px; border: 1px solid #dee2e6; text-align: left;">${item.name}</td>
                <td style="padding: 5px 10px; border: 1px solid #dee2e6; text-align: right;">$${item.price.toFixed(2)}</td>
            </tr>
        `).join('');

        // NOTA: Se usan los valores de los inputs ANTES de que se limpien.
        template.innerHTML = `
            <div style="font-family: Arial, sans-serif; padding: 20px; border: 1px solid #ccc; max-width: 700px; margin: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px;">
                    <h2 style="color: #007bff;">VET360 üêæ</h2>
                    <div style="text-align: right;">
                        <h4 style="margin: 0;">FACTURA #${document.getElementById('invoiceNum').value}</h4>
                        <p style="margin: 0; font-size: 14px;">Fecha: ${document.getElementById('invoiceDate').value}</p>
                    </div>
                </div>

                <h5 style="color: #28a745; margin-bottom: 15px;">Informaci√≥n del Cliente y Veterinaria</h5>
                <p style="margin: 5px 0;"><strong>Cliente:</strong> ${document.getElementById('clientName').value || 'N/A'}</p>
                <p style="margin: 5px 0;"><strong>Mascota:</strong> ${document.getElementById('petName').value || 'N/A'}</p>
                <p style="margin: 5px 0;"><strong>Veterinario:</strong> ${document.getElementById('vetSelect').value || 'N/A'}</p>
                
                <h5 style="color: #28a745; margin-top: 25px; margin-bottom: 10px;">Detalles de la Transacci√≥n</h5>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Servicio</th>
                            <th style="padding: 10px; border: 1px solid #dee2e6; text-align: right;">Precio</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                        <tr style="font-weight: bold; background-color: #e9ecef;">
                            <td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">TOTAL</td>
                            <td style="padding: 10px; text-align: right; border: 1px solid #dee2e6;">${totalText}</td>
                        </tr>
                    </tbody>
                </table>
                
                <p style="text-align: center; font-style: italic; font-size: 12px; color: #6c757d; margin-top: 30px;">Gracias por confiar en VET360 para el cuidado de su mascota.</p>
            </div>
        `;
    }

    /**
     * FUNCI√ìN PARA DESCARGAR EL PDF (Se llama desde el bot√≥n de Preview).
     * Usa la plantilla HTML ya creada en el DOM (pdf-template).
     */
    function downloadPDF() {
        const invoiceNum = document.getElementById('invoiceNum').value;
        const { jsPDF } = window.jspdf;
        const invoiceContent = document.getElementById('pdf-template');
        
        const downloadButton = document.getElementById('downloadPdfButton');
        downloadButton.disabled = true;
        downloadButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Descargando...`;

        // El HTML2Canvas toma la plantilla visible del preview
        html2canvas(invoiceContent, { scale: 3 }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4'); 
            const imgWidth = 210;
            const pageHeight = 295;
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;

            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            pdf.save(`Factura_${invoiceNum}.pdf`);
            
            showVetToast("PDF Descargado", `Factura ${invoiceNum} lista para impresi√≥n.`, 'üñ®Ô∏è', 'bg-info');

            // Reactivar bot√≥n
            downloadButton.disabled = false;
            downloadButton.innerHTML = `<i class="bi bi-file-earmark-pdf-fill"></i> Descargar PDF e Imprimir`;
        });
    }

</script>
</body>
</html>