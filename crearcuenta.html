<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Cuenta - VET360</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Sistema de validaciones VET360 -->
    <script src="./js/vet360-validations.js"></script>
</head>
<body>

<div id="navbar-container"></div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="bi me-2" id="toastIcon"></i>
            <strong class="me-auto" id="toastTitle">VET360</strong>
            <small>Ahora</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastBody">
            Mensaje de prueba.
        </div>
    </div>
</div>
<div class="container mt-5 mb-5">
    <div class="card container-bg p-4 p-md-5">
        <h2 class="mb-4 text-center text-primary"><i class="bi bi-person-plus-fill"></i> Crear Nueva Cuenta de Cliente</h2>
        
        <!-- Contenedor de errores -->
        <div id="error-container" class="d-none"></div>
        
        <form id="clientForm" novalidate>
            <section class="mb-5">
                <h3>Información del Cliente</h3>
                <hr class="mt-2 mb-4">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="accountName" class="form-label">Nombre del Cliente <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="accountName" required 
                               maxlength="50" 
                               placeholder="Ej: Juan Pérez"
                               title="Solo letras y espacios, máximo 50 caracteres">
                        <div class="form-text">Solo letras y espacios (2-50 caracteres)</div>
                    </div>
                    <div class="col-md-6">
                        <label for="accountOwner" class="form-label">Propietario / Empleado</label>
                        <input type="text" class="form-control" id="accountOwner" value="Cargando..." disabled>
                    </div>
                    <div class="col-md-6">
                        <label for="phone" class="form-label">Teléfono <span class="text-danger">*</span></label>
                        <input type="tel" class="form-control" id="phone" required
                               maxlength="15"
                               placeholder="Ej: +1 234 567 8900"
                               title="Formato válido de teléfono (7-15 dígitos)">
                        <div class="form-text">Formato: +código área número (7-15 dígitos)</div>
                    </div>
                    <div class="col-md-6">
                        <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" id="email" required
                               maxlength="100"
                               placeholder="Ej: cliente@email.com"
                               title="Formato válido de email">
                        <div class="form-text">Formato válido de correo electrónico</div>
                    </div>
                    <div class="col-12">
                         <label for="type" class="form-label">Tipo de Cliente</label>
                         <select id="type" class="form-select">
                            <option value="prospect">Prospecto</option>
                            <option value="regular" selected>Cliente Regular</option>
                            <option value="preferente">Cliente Preferente</option>
                         </select>
                    </div>
                </div>
            </section>

            <section class="mb-4">
                <h3>Detalles de la Mascota</h3>
                <hr class="mt-2 mb-4">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="petName" class="form-label">Nombre de la Mascota</label>
                        <input type="text" class="form-control" id="petName" 
                               maxlength="30"
                               placeholder="Ej: Firulais, Miau"
                               title="Solo letras y espacios, máximo 30 caracteres">
                        <div class="form-text">Solo letras y espacios (1-30 caracteres)</div>
                    </div>
                    <div class="col-md-6">
                        <label for="species" class="form-label">Especie</label>
                        <input type="text" class="form-control" id="species" 
                               maxlength="20"
                               placeholder="Ej: Perro, Gato, Conejo"
                               title="Solo letras y espacios, máximo 20 caracteres">
                        <div class="form-text">Ej: Perro, Gato, Conejo (2-20 caracteres)</div>
                    </div>
                    <div class="col-md-4">
                        <label for="breed" class="form-label">Raza</label>
                        <input type="text" class="form-control" id="breed" 
                               maxlength="30"
                               placeholder="Ej: Golden Retriever, Mestizo"
                               title="Solo letras y espacios, máximo 30 caracteres">
                        <div class="form-text">Opcional (2-30 caracteres)</div>
                    </div>
                    <div class="col-md-4">
                        <label for="age" class="form-label">Edad (años)</label>
                        <input type="number" class="form-control" id="age" 
                               min="0" max="30" step="1"
                               placeholder="Ej: 3"
                               title="Edad entre 0 y 30 años">
                        <div class="form-text">Entre 0 y 30 años</div>
                    </div>
                    <div class="col-md-4">
                        <label for="weight" class="form-label">Peso (kg)</label>
                        <input type="number" class="form-control" id="weight" 
                               min="0.1" max="200" step="0.1"
                               placeholder="Ej: 15.5"
                               title="Peso entre 0.1 y 200 kg">
                        <div class="form-text">Entre 0.1 y 200 kg</div>
                    </div>
                    <div class="col-12">
                        <label for="medicalHistory" class="form-label">Historial Médico / Notas</label>
                        <textarea class="form-control" id="medicalHistory" 
                                  rows="3" maxlength="500"
                                  placeholder="Alergias, medicamentos, cirugías previas, comportamiento, etc."
                                  title="Información médica relevante, máximo 500 caracteres"></textarea>
                        <div class="form-text">Opcional - Información médica relevante (máximo 500 caracteres)</div>
                    </div>
                </div>
            </section>

            <div class="d-flex justify-content-end gap-2 mt-5">
                <a href="mis_cuentas.html" class="btn btn-secondary"><i class="bi bi-x-circle"></i> Cancelar</a>
                <button type="submit" class="btn btn-primary" id="saveButton"><i class="bi bi-save"></i> Guardar Cuenta</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> 


<script>
    // Tu configuración de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBZoyZqhODCH90zcPdY_iT8mhh2S-X5FRE",
        authDomain: "vet360-d262a.firebaseapp.com",
        databaseURL: "https://vet360-d262a-default-rtdb.firebaseio.com",
        projectId: "vet360-d262a",
        storageBucket: "vet360-d262a.firebasestorage.app",
        messagingSenderId: "184009559961",
        appId: "1:184009559961:web:12b1311b6224a5d58ecd08",
        measurementId: "G-5K02J1Z7VZ"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();
    
    let currentUserName = "Michelle Perdomo (Ejemplo)"; // Valor por defecto

    // --- Inicialización ---
    document.addEventListener('DOMContentLoaded', function() {
        // Cargar Navbar
        fetch('navbar.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('navbar-container').innerHTML = data;
            });
            
        // 1. Obtener el nombre del usuario logeado
        auth.onAuthStateChanged(user => {
            const ownerInput = document.getElementById('accountOwner');
            if (user) {
                // Si el usuario está autenticado, usa su email o nombre si está disponible
                currentUserName = user.email || 'Usuario Autenticado';
                ownerInput.value = currentUserName;
            } else {
                ownerInput.value = currentUserName; // Usar valor por defecto si no hay login
            }
        });
        
        // 2. Asignar el evento de envío del formulario
        document.getElementById('clientForm').addEventListener('submit', handleFormSubmit);
        
        // 3. Aplicar validaciones en tiempo real a los inputs
        initializeInputValidations();
    });
    
    /**
     * Inicializa las validaciones en tiempo real para todos los inputs
     */
    function initializeInputValidations() {
        // Aplicar limitaciones a cada input
        vet360Validator.applyInputLimitations(document.getElementById('accountName'), 'name');
        vet360Validator.applyInputLimitations(document.getElementById('phone'), 'phone');
        vet360Validator.applyInputLimitations(document.getElementById('email'), 'email');
        vet360Validator.applyInputLimitations(document.getElementById('petName'), 'petName');
        vet360Validator.applyInputLimitations(document.getElementById('species'), 'name');
        vet360Validator.applyInputLimitations(document.getElementById('breed'), 'name');
        vet360Validator.applyInputLimitations(document.getElementById('age'), 'number');
        vet360Validator.applyInputLimitations(document.getElementById('weight'), 'decimal');
        vet360Validator.applyInputLimitations(document.getElementById('medicalHistory'), 'notes');
        
        // Validaciones en tiempo real para mostrar feedback inmediato
        document.getElementById('accountName').addEventListener('blur', function() {
            validateFieldRealTime('accountName', 'name');
        });
        
        document.getElementById('email').addEventListener('blur', function() {
            validateFieldRealTime('email', 'email');
        });
        
        document.getElementById('phone').addEventListener('blur', function() {
            validateFieldRealTime('phone', 'phone');
        });
        
        document.getElementById('petName').addEventListener('blur', function() {
            validateFieldRealTime('petName', 'petName');
        });
        
        document.getElementById('species').addEventListener('blur', function() {
            validateFieldRealTime('species', 'species');
        });
        
        // Limpiar errores cuando el usuario empieza a escribir
        const inputs = ['accountName', 'email', 'phone', 'petName', 'species', 'breed', 'age', 'weight'];
        inputs.forEach(inputId => {
            document.getElementById(inputId).addEventListener('input', function() {
                clearFieldError(inputId);
            });
        });
    }
    
    /**
     * Valida un campo específico en tiempo real
     */
    function validateFieldRealTime(fieldId, type) {
        const field = document.getElementById(fieldId);
        const value = field.value.trim();
        
        // Crear validador temporal para este campo
        const tempValidator = new VET360Validator();
        let isValid = false;
        
        switch (type) {
            case 'name':
                isValid = tempValidator.validateName(value, 'nombre');
                break;
            case 'email':
                isValid = tempValidator.validateEmail(value);
                break;
            case 'phone':
                isValid = tempValidator.validatePhone(value);
                break;
            case 'petName':
                isValid = value ? tempValidator.validatePetName(value) : true;
                break;
            case 'species':
                isValid = value ? tempValidator.validateSpecies(value) : true;
                break;
        }
        
        if (!isValid && value) {
            showFieldError(fieldId, tempValidator.getErrors()[0]?.message);
        } else {
            clearFieldError(fieldId);
        }
    }
    
    /**
     * Muestra error en un campo específico
     */
    function showFieldError(fieldId, message) {
        const field = document.getElementById(fieldId);
        field.classList.add('is-invalid');
        
        // Buscar o crear div de error
        let errorDiv = field.parentNode.querySelector('.invalid-feedback');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.className = 'invalid-feedback';
            field.parentNode.appendChild(errorDiv);
        }
        errorDiv.textContent = message;
    }
    
    /**
     * Limpia el error de un campo específico
     */
    function clearFieldError(fieldId) {
        const field = document.getElementById(fieldId);
        field.classList.remove('is-invalid');
        
        const errorDiv = field.parentNode.querySelector('.invalid-feedback');
        if (errorDiv) {
            errorDiv.textContent = '';
        }
    }
    
    // --------------------------------------------------------
    // FUNCIONES DE TOAST
    // --------------------------------------------------------
    
    /**
     * Muestra una notificación Toast de Bootstrap.
     * @param {string} title - Título del Toast.
     * @param {string} message - Cuerpo del mensaje.
     * @param {string} type - 'success', 'danger', 'warning', 'info'.
     */
    function showVetToast(title, message, type = 'success') {
        const toastEl = document.getElementById('liveToast');
        const toastTitleEl = document.getElementById('toastTitle');
        const toastBodyEl = document.getElementById('toastBody');
        const toastIconEl = document.getElementById('toastIcon');

        // 1. Configurar colores y íconos basados en el tipo
        let iconClass = 'bi-info-circle-fill text-info';
        
        if (type === 'success') {
            iconClass = 'bi-check-circle-fill text-success';
        } else if (type === 'danger') {
            iconClass = 'bi-exclamation-triangle-fill text-danger';
        } else if (type === 'warning') {
            iconClass = 'bi-exclamation-circle-fill text-warning';
        }

        // 2. Aplicar clases y contenido
        toastEl.className = 'toast border border-' + type; // Aplica el borde de color
        toastIconEl.className = 'bi me-2 ' + iconClass;
        toastTitleEl.textContent = title;
        toastBodyEl.textContent = message;

        // 3. Mostrar el Toast
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }


    // --------------------------------------------------------
    // FUNCIONES DE CONTROL
    // --------------------------------------------------------
    
    /**
     * Maneja el envío del formulario, recopila datos y los guarda en Firebase.
     */
    function handleFormSubmit(event) {
        event.preventDefault(); 
        
        const saveButton = document.getElementById('saveButton');
        
        // Limpiar errores previos
        vet360Validator.clearErrorsFromDOM('error-container');
        
        // 1. Recopilar datos del cliente
        const clientData = {
            name: document.getElementById('accountName').value.trim(),
            owner: document.getElementById('accountOwner').value,
            phone: document.getElementById('phone').value.trim(),
            email: document.getElementById('email').value.trim(),
            type: document.getElementById('type').value,
            createdAt: firebase.database.ServerValue.TIMESTAMP 
        };
        
        // 2. Recopilar datos de la mascota
        const petData = {
            name: document.getElementById('petName').value.trim(),
            species: document.getElementById('species').value.trim(),
            breed: document.getElementById('breed').value.trim(),
            age: parseInt(document.getElementById('age').value) || null,
            weight: parseFloat(document.getElementById('weight').value) || null,
            medicalHistory: document.getElementById('medicalHistory').value.trim()
        };

        // 3. Validación completa usando VET360Validator
        const formData = {
            name: clientData.name,
            email: clientData.email,
            phone: clientData.phone,
            pet: petData
        };
        
        if (!vet360Validator.validateClientForm(formData)) {
            vet360Validator.displayErrors('error-container');
            showVET360Toast("Error de Validación", "Por favor corrige los errores señalados", 'error');
            saveButton.disabled = false;
            saveButton.innerHTML = `<i class="bi bi-save"></i> Guardar Cuenta`;
            return;
        }

        // 4. Crear el objeto final
        const newClient = {
            ...clientData,
            pet: petData // Almacenamos la mascota dentro del objeto cliente
        };
        
        // 5. Guardar en Firebase Realtime Database en el nodo 'clients'
        database.ref('clients').push(newClient)
            .then(() => {
                showVET360Toast("Guardado Exitoso", `Cuenta de ${clientData.name} guardada correctamente.`, 'success');
                document.getElementById('clientForm').reset(); // Limpiar formulario
                
                // Redirigir al historial después de un breve tiempo
                setTimeout(() => {
                    window.location.href = 'mis_cuentas.html'; 
                }, 2000);

            })
            .catch(error => {
                console.error("Error al guardar la cuenta:", error);
                showVET360Toast("Error de Firebase", `No se pudo guardar la cuenta: ${error.message}`, 'error');
            })
            .finally(() => {
                saveButton.disabled = false;
                saveButton.innerHTML = `<i class="bi bi-save"></i> Guardar Cuenta`;
            });
    }

</script>

</body>
</html>

