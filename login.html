<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesi√≥n - VET360</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/style.css">
</head>
<body class="d-flex align-items-center justify-content-center vh-100">

<div class="container">
    <div class="row align-items-center justify-content-center">
        <div class="col-lg-6 d-none d-lg-block">
            <img src="./assets/imagenes/vet360login.png" alt="Imagen de veterinaria" class="img-fluid rounded-3">
        </div>

        <div class="col-lg-6 col-md-8">
            <div class="card p-4">
                <div class="card-body">
                    <div class="text-center mb-4">
                        <img src="./assets/imagenes/logovet360opcion 1.jpg" alt="VET360 Logo" class="logo-img">
                        <h1 class="logo">VET360 üêæ</h1>
                        <h2>Iniciar Sesi√≥n</h2>
                    </div>
                    
                    <div id="error-message" class="alert alert-danger d-none" role="alert"></div>
                    <div id="success-message" class="alert alert-success d-none" role="alert"></div>
                    
                    <form id="login-form">
                        <div class="mb-3">
                            <label for="email" class="form-label">Correo electr√≥nico</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Contrase√±a</label>
                            <input type="password" class="form-control" id="password" name="password" required minlength="6">
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="login-btn">
                                <span class="btn-text">Iniciar Sesi√≥n</span>
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            </button>
                        </div>
                        <div class="mt-3 text-center">
                            <small class="text-muted">¬øNecesitas ayuda? <a href="mailto:soporte@vet360.com">Contacta soporte</a></small>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Firebase SDK v12.5.0 (modular) -->
<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js';
    import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js';
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js';

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBZoyZqhODCH90zcPdY_iT8mhh2S-X5FRE",
        authDomain: "vet360-d262a.firebaseapp.com",
        databaseURL: "https://vet360-d262a-default-rtdb.firebaseio.com",
        projectId: "vet360-d262a",
        storageBucket: "vet360-d262a.firebasestorage.app",
        messagingSenderId: "184009559961",
        appId: "1:184009559961:web:12b1311b6224a5d58ecd08",
        measurementId: "G-5K02J1Z7VZ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);
    const analytics = getAnalytics(app);

    // UI elements
    const loginForm = document.getElementById('login-form');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('login-btn');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');

    // Show loading state
    function showLoading(show) {
        const btnText = loginBtn.querySelector('.btn-text');
        const spinner = loginBtn.querySelector('.spinner-border');
        
        if (show) {
            btnText.textContent = 'Iniciando...';
            spinner.classList.remove('d-none');
            loginBtn.disabled = true;
        } else {
            btnText.textContent = 'Iniciar Sesi√≥n';
            spinner.classList.add('d-none');
            loginBtn.disabled = false;
        }
    }

    // Show error message
    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.remove('d-none');
        successMessage.classList.add('d-none');
    }

    // Show success message
    function showSuccess(message) {
        successMessage.textContent = message;
        successMessage.classList.remove('d-none');
        errorMessage.classList.add('d-none');
    }

    // Hide all messages
    function hideMessages() {
        errorMessage.classList.add('d-none');
        successMessage.classList.add('d-none');
    }

    // Get user-friendly error message
    function getAuthErrorMessage(errorCode) {
        switch (errorCode) {
            case 'auth/user-not-found':
                return "‚ùå Usuario no encontrado. Verifica tu correo electr√≥nico.";
            case 'auth/wrong-password':
                return "‚ùå Contrase√±a incorrecta. Intenta de nuevo.";
            case 'auth/invalid-email':
                return "‚ùå El formato del correo electr√≥nico es incorrecto.";
            case 'auth/user-disabled':
                return "‚ùå Esta cuenta ha sido deshabilitada.";
            case 'auth/too-many-requests':
                return "‚ö†Ô∏è Demasiados intentos fallidos. Intenta m√°s tarde.";
            case 'auth/network-request-failed':
                return "üåê Error de conexi√≥n. Verifica tu internet.";
            case 'auth/email-already-in-use':
                return "‚ùå Este correo ya est√° registrado. Intenta iniciar sesi√≥n.";
            case 'auth/weak-password':
                return "‚ùå La contrase√±a debe tener al menos 6 caracteres.";
            case 'auth/invalid-credential':
                return "‚ùå Credenciales inv√°lidas. Verifica tu correo y contrase√±a.";
            default:
                return `üö® Error: ${errorCode}. Contacta al soporte t√©cnico.`;
        }
    }

    // Handle login
    async function handleLogin(email, password) {
        showLoading(true);
        hideMessages();

        try {
            console.log('Attempting to sign in user:', email);
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            
            console.log('User authenticated successfully, UID:', user.uid);
            showSuccess("‚úÖ Autenticaci√≥n exitosa! Verificando perfil...");
            
            // Check if user has a profile in Realtime Database
            console.log('Checking user profile in database...');
            const userRef = ref(database, 'users/' + user.uid);
            const snapshot = await get(userRef);
            
            if (snapshot.exists()) {
                const userData = snapshot.val();
                console.log('User profile found:', userData);
                
                if (userData.role && userData.isActive !== false) {
                    showSuccess("‚úÖ ¬°Inicio de sesi√≥n exitoso! Redirigiendo...");
                    
                    // Redirect after short delay to show success message
                    setTimeout(() => {
                        window.location.href = "dashboard.html";
                    }, 1500);
                } else {
                    showError("‚ùå Tu cuenta est√° inactiva. Contacta al administrador.");
                }
            } else {
                console.log('No profile found for user');
                showError("‚ö†Ô∏è Perfil incompleto. Tu cuenta necesita ser configurada por un administrador. Contacta al soporte t√©cnico.");
                
                // Optionally sign out the user since they don't have a profile
                // await signOut(auth);
            }

        } catch (error) {
            console.error("Firebase Auth Error:", error);
            showError(getAuthErrorMessage(error.code));
        } finally {
            showLoading(false);
        }
    }

    // Form validation
    function validateForm() {
        const email = emailInput.value.trim();
        const password = passwordInput.value;
        
        // Reset validation states
        emailInput.classList.remove('is-invalid');
        passwordInput.classList.remove('is-invalid');
        
        let isValid = true;
        
        if (!email || !email.includes('@')) {
            emailInput.classList.add('is-invalid');
            emailInput.nextElementSibling.textContent = 'Ingresa un correo v√°lido';
            isValid = false;
        }
        
        if (!password || password.length < 6) {
            passwordInput.classList.add('is-invalid');
            passwordInput.nextElementSibling.textContent = 'La contrase√±a debe tener al menos 6 caracteres';
            isValid = false;
        }
        
        return isValid;
    }

    // Event listeners
    loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!validateForm()) {
            return;
        }
        
        const email = emailInput.value.trim();
        const password = passwordInput.value;
        
        handleLogin(email, password);
    });

    // Clear validation on input
    emailInput.addEventListener('input', function() {
        this.classList.remove('is-invalid');
        hideMessages();
    });

    passwordInput.addEventListener('input', function() {
        this.classList.remove('is-invalid');
        hideMessages();
    });

    // Check if user is already logged in
    auth.onAuthStateChanged((user) => {
        if (user) {
            // User is signed in, redirect to dashboard
            window.location.href = "dashboard.html";
        }
    });
</script>

</body>
</html>
</body>
</html>