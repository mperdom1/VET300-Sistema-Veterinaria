<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Facturaci√≥n - VET360</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="./assets/css/style.css">
</head>
<body>

<div id="navbar-container"></div>

<!-- Verificaci√≥n de permisos -->
<div id="authLoading" class="text-center mt-5 p-5">
    <div class="spinner-border text-primary mb-3 large-spinner" role="status">
        <span class="visually-hidden">Verificando permisos...</span>
    </div>
    <h4 class="text-primary">Verificando Acceso de Facturaci√≥n</h4>
    <p class="text-muted">Solo personal autorizado puede acceder a la facturaci√≥n.</p>
</div>

<!-- Contenido principal -->
<div id="mainContent" class="d-none">
    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col">
                                <h1 class="mb-1">
                                    <i class="bi bi-receipt-cutoff"></i>
                                    Panel de Facturaci√≥n
                                </h1>
                                <p class="mb-0 opacity-75">Gesti√≥n de servicios y facturaci√≥n</p>
                            </div>
                            <div class="col-auto">
                                <div class="user-info bg-white text-info rounded p-2">
                                    <small>
                                        <i class="bi bi-person-circle"></i>
                                        <span id="userName">Cargando...</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPIs de facturaci√≥n -->
        <div class="row g-4 mb-4">
            <div class="col-md-6 col-lg-3">
                <div class="card border-success shadow-sm h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-currency-dollar text-success large-icon mb-2"></i>
                        <h5 class="card-title text-success">Facturas Hoy</h5>
                        <p class="fs-2 fw-bold" id="facturasHoy">-</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card border-warning shadow-sm h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-clock text-warning large-icon mb-2"></i>
                        <h5 class="card-title text-warning">Pendientes</h5>
                        <p class="fs-2 fw-bold" id="facturasPendientes">-</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card border-info shadow-sm h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-graph-up text-info large-icon mb-2"></i>
                        <h5 class="card-title text-info">Total D√≠a</h5>
                        <p class="fs-2 fw-bold" id="totalDia">$ -</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3">
                <div class="card border-secondary shadow-sm h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-list-check text-secondary large-icon mb-2"></i>
                        <h5 class="card-title text-secondary">Servicios</h5>
                        <p class="fs-2 fw-bold" id="totalServicios">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Acciones principales -->
        <div class="row mb-4">
            <div class="col">
                <h3 class="mb-3 text-secondary">
                    <i class="bi bi-lightning-charge"></i>
                    Acciones R√°pidas
                </h3>
                <div class="row g-3">
                    <div class="col-md-6 col-lg-4">
                        <div class="card border-primary h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-plus-circle-fill text-primary large-icon mb-3"></i>
                                <h5 class="card-title">Nueva Factura</h5>
                                <p class="card-text text-muted">Crear factura para servicios prestados</p>
                                <button class="btn btn-primary btn-lg w-100" onclick="window.location.href='crear_factura.html'">
                                    <i class="bi bi-receipt"></i>
                                    Crear Factura
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-4">
                        <div class="card border-success h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-folder2-open text-success large-icon mb-3"></i>
                                <h5 class="card-title">Ver Facturas</h5>
                                <p class="card-text text-muted">Gestionar facturas existentes</p>
                                <button class="btn btn-success btn-lg w-100" onclick="window.location.href='ver_facturas.html'">
                                    <i class="bi bi-list-ul"></i>
                                    Ver Todas
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-4">
                        <div class="card border-info h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-gear-fill text-info large-icon mb-3"></i>
                                <h5 class="card-title">Servicios</h5>
                                <p class="card-text text-muted">Cat√°logo de servicios y precios</p>
                                <button class="btn btn-info btn-lg w-100" onclick="window.location.href='servicios.html'">
                                    <i class="bi bi-list-check"></i>
                                    Ver Servicios
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Facturas recientes -->
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <div class="row align-items-center">
                            <div class="col">
                                <h5 class="mb-0">
                                    <i class="bi bi-clock-history"></i>
                                    Facturas Recientes
                                </h5>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-light btn-sm" onclick="refreshInvoices()">
                                    <i class="bi bi-arrow-clockwise"></i>
                                    Actualizar
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Factura #</th>
                                        <th>Cliente</th>
                                        <th>Servicios</th>
                                        <th>Total</th>
                                        <th>Estado</th>
                                        <th>Fecha</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="invoicesTableBody">
                                    <!-- Cargado din√°micamente -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="emptyInvoices" class="text-center py-4 d-none">
                            <i class="bi bi-receipt text-muted large-icon"></i>
                            <h5 class="text-muted mt-3">No hay facturas recientes</h5>
                            <p class="text-muted">Las facturas creadas aparecer√°n aqu√≠.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Acceso denegado a secciones m√©dicas -->
        <div class="row mt-5">
            <div class="col">
                <div class="alert alert-warning">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <i class="bi bi-shield-exclamation text-warning large-icon"></i>
                        </div>
                        <div class="col">
                            <h6 class="alert-heading mb-1">Acceso Restringido</h6>
                            <p class="mb-0">
                                Como personal de facturaci√≥n, tu acceso est√° limitado a:
                                <strong>Facturaci√≥n, Servicios y Atenci√≥n al Cliente</strong>.
                                Para casos m√©dicos, contacta al veterinario.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase SDK v9 (modular) -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBZoyZqhODCH90zcPdY_iT8mhh2S-X5FRE",
        authDomain: "vet360-d262a.firebaseapp.com",
        databaseURL: "https://vet360-d262a-default-rtdb.firebaseio.com",
        projectId: "vet360-d262a",
        storageBucket: "vet360-d262a.firebasestorage.app",
        messagingSenderId: "184009559961",
        appId: "1:184009559961:web:12b1311b6224a5d58ecd08",
        measurementId: "G-5K02J1Z7VZ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elementos del DOM
    const mainContent = document.getElementById('mainContent');
    const authLoading = document.getElementById('authLoading');
    const userName = document.getElementById('userName');
    const invoicesTableBody = document.getElementById('invoicesTableBody');
    const emptyInvoices = document.getElementById('emptyInvoices');

    // Datos simulados de facturas
    const mockInvoices = [
        {
            id: 'FAC-001',
            cliente: 'Mar√≠a Gonz√°lez',
            servicios: ['Consulta General', 'Vacunaci√≥n'],
            total: 85.00,
            estado: 'Pagada',
            fecha: '2025-10-31',
            hora: '10:30'
        },
        {
            id: 'FAC-002', 
            cliente: 'Jos√© Ram√≠rez',
            servicios: ['Cirug√≠a', 'Hospitalizaci√≥n'],
            total: 450.00,
            estado: 'Pendiente',
            fecha: '2025-10-31',
            hora: '14:15'
        },
        {
            id: 'FAC-003',
            cliente: 'Carmen Jim√©nez',
            servicios: ['Control Post-Cirug√≠a'],
            total: 60.00,
            estado: 'Pagada',
            fecha: '2025-10-30',
            hora: '16:45'
        }
    ];

    // Verificar permisos de facturaci√≥n
    async function checkBillingAccess(uid) {
        try {
            const userDoc = await getDoc(doc(db, 'users', uid));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                // Solo recepcionistas, admins e IT pueden facturar
                return userData.role === 'recepcionista' || userData.role === 'admin' || userData.role === 'it_support';
            }
            return false;
        } catch (error) {
            console.error('Error checking billing access:', error);
            return false;
        }
    }

    // Obtener perfil del usuario
    async function getUserProfile(uid) {
        try {
            const userDoc = await getDoc(doc(db, 'users', uid));
            if (userDoc.exists()) {
                return userDoc.data();
            }
            return null;
        } catch (error) {
            console.error('Error getting user profile:', error);
            return null;
        }
    }

    // Mostrar acceso denegado
    function showAccessDenied() {
        authLoading.innerHTML = `
            <i class="bi bi-credit-card-2-front text-danger mb-3 large-icon"></i>
            <h4 class="text-danger">Acceso Restringido</h4>
            <p class="text-muted">Solo personal de recepci√≥n y administraci√≥n pueden acceder a la facturaci√≥n.</p>
            <a href="dashboard.html" class="btn btn-primary">Volver al Dashboard</a>
        `;
    }

    // Cargar KPIs de facturaci√≥n
    function loadBillingKPIs() {
        // Datos simulados
        const today = new Date().toISOString().split('T')[0];
        const todayInvoices = mockInvoices.filter(inv => inv.fecha === today);
        const pendingInvoices = mockInvoices.filter(inv => inv.estado === 'Pendiente');
        const totalToday = todayInvoices.reduce((sum, inv) => sum + inv.total, 0);

        document.getElementById('facturasHoy').textContent = todayInvoices.length;
        document.getElementById('facturasPendientes').textContent = pendingInvoices.length;
        document.getElementById('totalDia').textContent = `$${totalToday.toFixed(2)}`;
        document.getElementById('totalServicios').textContent = '25'; // Simulado
    }

    // Obtener color del estado
    function getStatusColor(estado) {
        const colors = {
            'Pagada': 'success',
            'Pendiente': 'warning',
            'Vencida': 'danger',
            'Cancelada': 'secondary'
        };
        return colors[estado] || 'secondary';
    }

    // Formatear fecha
    function formatDate(fecha, hora) {
        const options = { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric'
        };
        const formattedDate = new Date(fecha).toLocaleDateString('es-ES', options);
        return `${formattedDate} ${hora}`;
    }

    // Mostrar facturas en la tabla
    function displayInvoices() {
        if (mockInvoices.length === 0) {
            invoicesTableBody.innerHTML = '';
            emptyInvoices.classList.remove('d-none');
            return;
        }

        emptyInvoices.classList.add('d-none');
        
        invoicesTableBody.innerHTML = mockInvoices.map(invoice => `
            <tr>
                <td>
                    <strong class="text-primary">${invoice.id}</strong>
                </td>
                <td>
                    <i class="bi bi-person"></i>
                    ${invoice.cliente}
                </td>
                <td>
                    <small class="text-muted">
                        ${invoice.servicios.join(', ')}
                    </small>
                </td>
                <td>
                    <strong class="text-success">$${invoice.total.toFixed(2)}</strong>
                </td>
                <td>
                    <span class="badge bg-${getStatusColor(invoice.estado)}">
                        ${invoice.estado}
                    </span>
                </td>
                <td>
                    <small class="text-muted">
                        ${formatDate(invoice.fecha, invoice.hora)}
                    </small>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="viewInvoice('${invoice.id}')" title="Ver">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-success" onclick="printInvoice('${invoice.id}')" title="Imprimir">
                            <i class="bi bi-printer"></i>
                        </button>
                        ${invoice.estado === 'Pendiente' ? `
                            <button class="btn btn-outline-warning" onclick="markPaid('${invoice.id}')" title="Marcar como Pagada">
                                <i class="bi bi-check-circle"></i>
                            </button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // Funciones globales para acciones
    window.viewInvoice = function(invoiceId) {
        alert(`üîç Ver detalles de la factura: ${invoiceId}`);
        // Aqu√≠ ir√≠a la l√≥gica para mostrar detalles
    };

    window.printInvoice = function(invoiceId) {
        alert(`üñ®Ô∏è Imprimir factura: ${invoiceId}`);
        // Aqu√≠ ir√≠a la l√≥gica de impresi√≥n
    };

    window.markPaid = function(invoiceId) {
        if (confirm(`¬øMarcar factura ${invoiceId} como pagada?`)) {
            const invoice = mockInvoices.find(inv => inv.id === invoiceId);
            if (invoice) {
                invoice.estado = 'Pagada';
                displayInvoices();
                loadBillingKPIs();
                alert('‚úÖ Factura marcada como pagada');
            }
        }
    };

    window.refreshInvoices = function() {
        displayInvoices();
        loadBillingKPIs();
        alert('üîÑ Datos actualizados');
    };

    // Cargar navbar
    document.addEventListener('DOMContentLoaded', function() {
        fetch('navbar.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('navbar-container').innerHTML = data;
            })
            .catch(error => console.error('Error loading navbar:', error));
    });

    // Autenticaci√≥n y autorizaci√≥n
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const hasAccess = await checkBillingAccess(user.uid);
            
            if (hasAccess) {
                const userProfile = await getUserProfile(user.uid);
                
                // Mostrar nombre del usuario
                if (userProfile) {
                    userName.textContent = `${userProfile.firstName} ${userProfile.lastName}`;
                }
                
                // Mostrar contenido y cargar datos
                mainContent.classList.remove('d-none');
                authLoading.style.display = 'none';
                
                loadBillingKPIs();
                displayInvoices();
            } else {
                showAccessDenied();
            }
        } else {
            authLoading.innerHTML = `
                <i class="bi bi-lock-fill text-danger mb-3 large-icon"></i>
                <h4 class="text-danger">Acceso Denegado</h4>
                <p class="text-muted">Necesitas iniciar sesi√≥n. Redirigiendo...</p>
            `;
            
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
        }
    });
</script>

</body>
</html>