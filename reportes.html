<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes - VET360</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="./assets/css/style.css">
    <!-- Sistema de validaciones VET360 -->
    <script src="./js/vet360-validations.js"></script>
</head>
<body>

<!-- Indicador de carga -->
<div id="authLoading" class="text-center mt-5 p-5">
    <div class="spinner-border text-primary mb-3" role="status">
        <span class="visually-hidden">Cargando...</span>
    </div>
    <h4 class="text-primary">Cargando Reportes...</h4>
    <div class="mt-4">
        <button class="btn btn-outline-primary" onclick="forzarCarga()">
            <i class="bi bi-bootstrap-reboot"></i> Cargar Forzado
        </button>
        <p class="text-muted small mt-2">Si la carga tarda mucho, usa el bot√≥n de arriba</p>
    </div>
</div>

<div id="navbar-container"></div>

<!-- Contenido principal -->
<div id="mainContent" class="hidden-content">
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-1">üìä Reportes y Estad√≠sticas</h1>
                    <p class="text-muted">An√°lisis y m√©tricas del sistema VET360</p>
                </div>
                <div>
                    <button class="btn btn-outline-primary" onclick="window.print()">
                        <i class="bi bi-printer me-1"></i> Imprimir
                    </button>
                </div>
            </div>

            <!-- Filtros de Fecha -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-3">üîç Filtros de Per√≠odo</h5>
                            <div class="row g-3 align-items-end">
                                <div class="col-md-3">
                                    <label for="fechaInicio" class="form-label">Fecha Inicio</label>
                                    <input type="date" class="form-select" id="fechaInicio">
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-3">
                                    <label for="fechaFin" class="form-label">Fecha Fin</label>
                                    <input type="date" class="form-select" id="fechaFin">
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-3">
                                    <label for="periodoRapido" class="form-label">Per√≠odos R√°pidos</label>
                                    <select class="form-select" id="periodoRapido" onchange="aplicarPeriodoRapido()">
                                        <option value="">Personalizado</option>
                                        <option value="hoy">Hoy</option>
                                        <option value="semana">Esta Semana</option>
                                        <option value="mes">Este Mes</option>
                                        <option value="trimestre">Este Trimestre</option>
                                        <option value="a√±o">Este A√±o</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-primary w-100" onclick="aplicarFiltros()">
                                        <i class="bi bi-funnel"></i> Aplicar Filtros
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- KPIs Principales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <i class="bi bi-people-fill text-primary large-icon"></i>
                    <h3 class="mt-3">156</h3>
                    <p class="text-muted">Total Pacientes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <i class="bi bi-calendar-check-fill text-success large-icon"></i>
                    <h3 class="mt-3">23</h3>
                    <p class="text-muted">Citas Hoy</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <i class="bi bi-currency-dollar text-warning large-icon"></i>
                    <h3 class="mt-3">$12,450</h3>
                    <p class="text-muted">Ingresos Mes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body text-center">
                    <i class="bi bi-heart-pulse-fill text-info large-icon"></i>
                    <h3 class="mt-3">89%</h3>
                    <p class="text-muted">Satisfacci√≥n</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Gr√°ficos y Reportes -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">üìà Ingresos Mensuales</h5>
                </div>
                <div class="card-body">
                    <div class="text-center py-5">
                        <i class="bi bi-bar-chart-line text-muted large-report-icon"></i>
                        <p class="text-muted mt-3">Gr√°fico de ingresos por mes</p>
                        <small class="text-muted">Funcionalidad en desarrollo</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">üèÜ Top Servicios</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Consulta General
                            <span class="badge bg-primary rounded-pill">45</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Vacunaci√≥n
                            <span class="badge bg-success rounded-pill">32</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Cirug√≠a Menor
                            <span class="badge bg-warning rounded-pill">18</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Desparasitaci√≥n
                            <span class="badge bg-info rounded-pill">25</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reportes Disponibles -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">üìã Reportes Disponibles</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card mb-3 report-card">
                                <div class="card-body text-center">
                                    <i class="bi bi-file-earmark-medical text-primary mb-3 medium-report-icon"></i>
                                    <h6>Reporte de Pacientes</h6>
                                    <p class="text-muted small">Listado completo de pacientes</p>
                                    <button class="btn btn-sm btn-outline-primary" onclick="generateReport('pacientes')">
                                        <i class="bi bi-download me-1"></i> Generar
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card mb-3 report-card">
                                <div class="card-body text-center">
                                    <i class="bi bi-calendar-event text-success mb-3 medium-report-icon"></i>
                                    <h6>Reporte de Citas</h6>
                                    <p class="text-muted small">Citas por per√≠odo</p>
                                    <button class="btn btn-sm btn-outline-success" onclick="generateReport('citas')">
                                        <i class="bi bi-download me-1"></i> Generar
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card mb-3 report-card">
                                <div class="card-body text-center">
                                    <i class="bi bi-receipt text-warning mb-3 medium-report-icon"></i>
                                    <h6>Reporte Financiero</h6>
                                    <p class="text-muted small">Ingresos y gastos</p>
                                    <button class="btn btn-sm btn-outline-warning" onclick="generateReport('financiero')">
                                        <i class="bi bi-download me-1"></i> Generar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
    // Importar Firebase
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js';
    import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js';

    // Configuraci√≥n de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBZoyZqhODCH90zcPdY_iT8mhh2S-X5FRE",
        authDomain: "vet360-d262a.firebaseapp.com",
        databaseURL: "https://vet360-d262a-default-rtdb.firebaseio.com",
        projectId: "vet360-d262a",
        storageBucket: "vet360-d262a.firebasestorage.app",
        messagingSenderId: "184009559961",
        appId: "1:184009559961:web:12b1311b6224a5d58ecd08"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);

    // Referencias DOM
    const authLoading = document.getElementById('authLoading');
    const mainContent = document.getElementById('mainContent');

    // Cargar navbar
    fetch('navbar.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('navbar-container').innerHTML = data;
        })
        .catch(error => console.error('Error loading navbar:', error));

    // Variables globales
    let currentUser = null;
    let allPacientes = [];
    let allCitas = [];
    let allFacturas = [];
    let fechaInicio = null;
    let fechaFin = null;

    // Verificar autenticaci√≥n - SIMPLIFICADO
    onAuthStateChanged(auth, async (user) => {
        console.log('üîç Verificando autenticaci√≥n...');
        
        if (user) {
            console.log('‚úÖ Usuario autenticado:', user.email);
            currentUser = user;
            
            // MOSTRAR INMEDIATAMENTE - sin verificar permisos complicados
            console.log('üìä Mostrando reportes inmediatamente...');
            
            // Establecer fechas por defecto
            establecerFechasPorDefecto();
            
            // Cargar datos b√°sicos (sin esperar)
            cargarDatosReportesBasicos();
            
            // Mostrar la interfaz
            authLoading.classList.add('d-none');
            mainContent.classList.remove('hidden-content');
            
            console.log('‚úÖ Reportes mostrados correctamente');
        } else {
            console.log('‚ùå Usuario no autenticado');
            window.location.href = 'login.html';
        }
    });

    // Cargar datos b√°sicos sin bloquear la interfaz
    async function cargarDatosReportesBasicos() {
        console.log('üìä Cargando datos b√°sicos...');
        
        // Mostrar datos de ejemplo inmediatamente
        mostrarDatosEjemplo();
        
        // Intentar cargar datos reales en segundo plano
        setTimeout(async () => {
            try {
                await cargarDatosReportes();
            } catch (error) {
                console.warn('‚ö†Ô∏è No se pudieron cargar datos reales, usando datos de ejemplo');
            }
        }, 1000);
    }

    // Mostrar datos de ejemplo inmediatamente
    function mostrarDatosEjemplo() {
        console.log('üìä Mostrando datos de ejemplo...');
        
        // KPIs de ejemplo
        const ejemploKPIs = {
            pacientes: 42,
            citasHoy: 8,
            ingresos: 15750,
            satisfaccion: 92
        };
        
        // Actualizar KPIs con datos de ejemplo
        const totalPacientesElement = document.querySelector('.card.border-primary h3');
        if (totalPacientesElement) totalPacientesElement.textContent = ejemploKPIs.pacientes;
        
        const citasHoyElement = document.querySelector('.card.border-success h3');
        if (citasHoyElement) citasHoyElement.textContent = ejemploKPIs.citasHoy;
        
        const ingresosElement = document.querySelector('.card.border-warning h3');
        if (ingresosElement) ingresosElement.textContent = `$${ejemploKPIs.ingresos.toLocaleString()}`;
        
        const satisfaccionElement = document.querySelector('.card.border-info h3');
        if (satisfaccionElement) satisfaccionElement.textContent = `${ejemploKPIs.satisfaccion}%`;
        
        console.log('‚úÖ Datos de ejemplo mostrados');
        
        // Mostrar notificaci√≥n informativa
        setTimeout(() => {
            showVET360Toast('Datos Cargados', 'Reportes listos para usar. Algunos datos pueden ser de ejemplo.', 'info');
        }, 500);
    }

    // Mostrar mensaje de acceso denegado
    function showAccessDenied(message) {
        authLoading.innerHTML = `
            <div class="alert alert-warning text-center p-5">
                <i class="bi bi-shield-exclamation fs-1 text-warning mb-3"></i>
                <h4>Acceso Restringido</h4>
                <p>${message}</p>
                <div class="mt-3">
                    <button class="btn btn-primary me-2" onclick="window.location.href='dashboard.html'">
                        <i class="bi bi-house"></i> Ir al Dashboard
                    </button>
                    <button class="btn btn-outline-secondary" onclick="window.location.href='login.html'">
                        <i class="bi bi-box-arrow-right"></i> Cerrar Sesi√≥n
                    </button>
                </div>
            </div>
        `;
        authLoading.classList.remove('d-none');
    }

    // Cargar datos para reportes
    async function cargarDatosReportes() {
        try {
            console.log('Iniciando carga de datos...');
            
            // Cargar datos con timeout y manejo de errores individual
            const [pacientes, citas, facturas] = await Promise.allSettled([
                Promise.race([cargarPacientes(), new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout pacientes')), 10000))]),
                Promise.race([cargarCitas(), new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout citas')), 10000))]),
                Promise.race([cargarFacturas(), new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout facturas')), 10000))])
            ]);

            // Procesar resultados
            allPacientes = pacientes.status === 'fulfilled' ? pacientes.value : [];
            allCitas = citas.status === 'fulfilled' ? citas.value : [];
            allFacturas = facturas.status === 'fulfilled' ? facturas.value : [];

            console.log('Datos cargados:', {
                pacientes: allPacientes.length,
                citas: allCitas.length,
                facturas: allFacturas.length
            });

            // Establecer fechas por defecto (este mes)
            establecerFechasPorDefecto();
            
            // Actualizar interfaz con datos disponibles
            actualizarKPIs(allPacientes, allCitas, allFacturas);
            actualizarTopServicios(allCitas);
            
            console.log('‚úÖ Carga de datos completada');
        } catch (error) {
            console.error('‚ùå Error cargando datos de reportes:', error);
            // Usar datos por defecto en caso de error
            allPacientes = [];
            allCitas = [];
            allFacturas = [];
            establecerFechasPorDefecto();
            actualizarKPIs([], [], []);
            actualizarTopServicios([]);
        }
    }

    // Establecer fechas por defecto
    function establecerFechasPorDefecto() {
        try {
            console.log('üìÖ Configurando fechas por defecto...');
            
            const ahora = new Date();
            const primerDiaDelMes = new Date(ahora.getFullYear(), ahora.getMonth(), 1);
            const ultimoDiaDelMes = new Date(ahora.getFullYear(), ahora.getMonth() + 1, 0);
            
            fechaInicio = primerDiaDelMes.toISOString().split('T')[0];
            fechaFin = ultimoDiaDelMes.toISOString().split('T')[0];
            
            const fechaInicioElement = document.getElementById('fechaInicio');
            const fechaFinElement = document.getElementById('fechaFin');
            const periodoRapidoElement = document.getElementById('periodoRapido');
            
            if (fechaInicioElement) fechaInicioElement.value = fechaInicio;
            if (fechaFinElement) fechaFinElement.value = fechaFin;
            if (periodoRapidoElement) periodoRapidoElement.value = 'mes';
            
            console.log('‚úÖ Fechas configuradas:', fechaInicio, 'a', fechaFin);
        } catch (error) {
            console.error('‚ùå Error configurando fechas:', error);
            // Valores por defecto simples
            fechaInicio = '2025-11-01';
            fechaFin = '2025-11-30';
        }
    }

    // Cargar pacientes
    async function cargarPacientes() {
        try {
            console.log('Cargando pacientes...');
            const clientsRef = ref(database, 'clients');
            const snapshot = await get(clientsRef);
            
            if (snapshot.exists()) {
                const clientsData = snapshot.val();
                console.log('Datos de clientes encontrados:', Object.keys(clientsData).length);
                
                const clients = Object.entries(clientsData).map(([id, data]) => ({
                    id,
                    ...data
                }));
                
                const pacientesConMascotas = clients.filter(client => client.pet && client.pet.name);
                console.log('Pacientes con mascotas:', pacientesConMascotas.length);
                
                return pacientesConMascotas;
            }
            
            console.log('No se encontraron clientes');
            return [];
        } catch (error) {
            console.error('Error cargando pacientes:', error);
            return [];
        }
    }

    // Cargar citas
    async function cargarCitas() {
        try {
            console.log('Cargando citas...');
            const citasRef = ref(database, 'appointments');
            const snapshot = await get(citasRef);
            
            if (snapshot.exists()) {
                const citasData = snapshot.val();
                console.log('Citas encontradas:', Object.keys(citasData).length);
                
                return Object.entries(citasData).map(([id, data]) => ({
                    id,
                    ...data
                }));
            }
            
            console.log('No se encontraron citas');
            return [];
        } catch (error) {
            console.error('Error cargando citas:', error);
            return [];
        }
    }

    // Cargar facturas
    async function cargarFacturas() {
        try {
            console.log('Cargando facturas...');
            const facturasRef = ref(database, 'invoices');
            const snapshot = await get(facturasRef);
            
            if (snapshot.exists()) {
                const facturasData = snapshot.val();
                console.log('Facturas encontradas:', Object.keys(facturasData).length);
                
                return Object.entries(facturasData).map(([id, data]) => ({
                    id,
                    ...data
                }));
            }
            
            console.log('No se encontraron facturas');
            return [];
        } catch (error) {
            console.error('Error cargando facturas:', error);
            return [];
        }
    }

    // Actualizar KPIs
    function actualizarKPIs(pacientes, citas, facturas) {
        try {
            console.log('Actualizando KPIs...');
            
            // Total pacientes
            const totalPacientesElement = document.querySelector('.card.border-primary h3');
            if (totalPacientesElement) {
                totalPacientesElement.textContent = pacientes.length;
            }

            // Citas de hoy
            const today = new Date().toISOString().split('T')[0];
            const citasHoy = citas.filter(cita => cita.date === today);
            const citasHoyElement = document.querySelector('.card.border-success h3');
            if (citasHoyElement) {
                citasHoyElement.textContent = citasHoy.length;
            }

            // Ingresos del mes
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const ingresosDelMes = facturas
                .filter(factura => {
                    if (!factura.date && !factura.createdAt) return false;
                    const facturaDate = new Date(factura.date || factura.createdAt);
                    return facturaDate.getMonth() === currentMonth && facturaDate.getFullYear() === currentYear;
                })
                .reduce((total, factura) => total + (parseFloat(factura.total) || 0), 0);
            
            const ingresosElement = document.querySelector('.card.border-warning h3');
            if (ingresosElement) {
                ingresosElement.textContent = `$${ingresosDelMes.toLocaleString()}`;
            }

            // Satisfacci√≥n (calculada en base a citas completadas)
            const citasCompletadas = citas.filter(cita => cita.status === 'completed').length;
            const satisfaccion = citas.length > 0 ? Math.round((citasCompletadas / citas.length) * 100) : 85;
            const satisfaccionElement = document.querySelector('.card.border-info h3');
            if (satisfaccionElement) {
                satisfaccionElement.textContent = `${satisfaccion}%`;
            }
            
            console.log('‚úÖ KPIs actualizados:', {
                pacientes: pacientes.length,
                citasHoy: citasHoy.length,
                ingresos: ingresosDelMes,
                satisfaccion: satisfaccion
            });
        } catch (error) {
            console.error('Error actualizando KPIs:', error);
        }
    }

    // Actualizar top servicios
    function actualizarTopServicios(citas) {
        const servicios = {};
        
        citas.forEach(cita => {
            const servicio = cita.service || cita.type || 'Consulta General';
            servicios[servicio] = (servicios[servicio] || 0) + 1;
        });

        const topServicios = Object.entries(servicios)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 4);

        const colores = ['primary', 'success', 'warning', 'info'];
        const listContainer = document.querySelector('.list-group.list-group-flush');
        
        if (topServicios.length > 0) {
            listContainer.innerHTML = topServicios.map(([servicio, cantidad], index) => `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    ${servicio}
                    <span class="badge bg-${colores[index]} rounded-pill">${cantidad}</span>
                </div>
            `).join('');
        }
    }

    // Funci√≥n para generar reportes
    window.generateReport = function(tipo) {
        const reportTypes = {
            'pacientes': generarReportePacientes,
            'citas': generarReporteCitas,
            'financiero': generarReporteFinanciero
        };

        if (reportTypes[tipo]) {
            reportTypes[tipo]();
        } else {
            showVET360Toast('Error', 'Tipo de reporte no reconocido', 'error');
        }
    };

    // Generar reporte de pacientes
    async function generarReportePacientes() {
        try {
            showVET360Toast('Generando Reporte', 'Creando reporte de pacientes...', 'info');
            
            const pacientes = await cargarPacientes();
            
            if (pacientes.length === 0) {
                showVET360Toast('Sin Datos', 'No hay pacientes registrados para generar el reporte', 'warning');
                return;
            }

            let reporteHTML = `
                <h2>üìã Reporte de Pacientes - VET360</h2>
                <p><strong>Fecha:</strong> ${new Date().toLocaleDateString()}</p>
                <p><strong>Total de Pacientes:</strong> ${pacientes.length}</p>
                <hr>
                <table border="1" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 8px;">Mascota</th>
                            <th style="padding: 8px;">Especie</th>
                            <th style="padding: 8px;">Raza</th>
                            <th style="padding: 8px;">Edad</th>
                            <th style="padding: 8px;">Propietario</th>
                            <th style="padding: 8px;">Tel√©fono</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            pacientes.forEach(paciente => {
                reporteHTML += `
                    <tr>
                        <td style="padding: 8px;">${paciente.pet.name || 'N/A'}</td>
                        <td style="padding: 8px;">${paciente.pet.species || 'N/A'}</td>
                        <td style="padding: 8px;">${paciente.pet.breed || 'N/A'}</td>
                        <td style="padding: 8px;">${paciente.pet.age || 'N/A'}</td>
                        <td style="padding: 8px;">${paciente.name || paciente.owner || 'N/A'}</td>
                        <td style="padding: 8px;">${paciente.phone || 'N/A'}</td>
                    </tr>
                `;
            });

            reporteHTML += `
                    </tbody>
                </table>
            `;

            descargarReporte(reporteHTML, 'reporte-pacientes');
            
        } catch (error) {
            console.error('Error generando reporte de pacientes:', error);
            showVET360Toast('Error', 'No se pudo generar el reporte de pacientes', 'error');
        }
    }

    // Generar reporte de citas
    async function generarReporteCitas() {
        try {
            showVET360Toast('Generando Reporte', 'Creando reporte de citas...', 'info');
            
            const citas = await cargarCitas();
            
            if (citas.length === 0) {
                showVET360Toast('Sin Datos', 'No hay citas registradas para generar el reporte', 'warning');
                return;
            }

            let reporteHTML = `
                <h2>üìÖ Reporte de Citas - VET360</h2>
                <p><strong>Fecha:</strong> ${new Date().toLocaleDateString()}</p>
                <p><strong>Total de Citas:</strong> ${citas.length}</p>
                <hr>
                <table border="1" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 8px;">Fecha</th>
                            <th style="padding: 8px;">Hora</th>
                            <th style="padding: 8px;">Paciente</th>
                            <th style="padding: 8px;">Servicio</th>
                            <th style="padding: 8px;">Estado</th>
                            <th style="padding: 8px;">Veterinario</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            citas.forEach(cita => {
                const estadoTexto = {
                    'scheduled': 'Programada',
                    'completed': 'Completada', 
                    'cancelled': 'Cancelada',
                    'in_progress': 'En Progreso'
                };

                reporteHTML += `
                    <tr>
                        <td style="padding: 8px;">${cita.date || 'N/A'}</td>
                        <td style="padding: 8px;">${cita.time || 'N/A'}</td>
                        <td style="padding: 8px;">${cita.petName || 'N/A'}</td>
                        <td style="padding: 8px;">${cita.service || cita.type || 'N/A'}</td>
                        <td style="padding: 8px;">${estadoTexto[cita.status] || cita.status || 'N/A'}</td>
                        <td style="padding: 8px;">${cita.veterinarian || 'N/A'}</td>
                    </tr>
                `;
            });

            reporteHTML += `
                    </tbody>
                </table>
            `;

            descargarReporte(reporteHTML, 'reporte-citas');
            
        } catch (error) {
            console.error('Error generando reporte de citas:', error);
            showVET360Toast('Error', 'No se pudo generar el reporte de citas', 'error');
        }
    }

    // Generar reporte financiero
    async function generarReporteFinanciero() {
        try {
            showVET360Toast('Generando Reporte', 'Creando reporte financiero...', 'info');
            
            const facturas = await cargarFacturas();
            
            if (facturas.length === 0) {
                showVET360Toast('Sin Datos', 'No hay facturas registradas para generar el reporte', 'warning');
                return;
            }

            const totalIngresos = facturas.reduce((total, factura) => 
                total + (parseFloat(factura.total) || 0), 0);

            let reporteHTML = `
                <h2>üí∞ Reporte Financiero - VET360</h2>
                <p><strong>Fecha:</strong> ${new Date().toLocaleDateString()}</p>
                <p><strong>Total de Facturas:</strong> ${facturas.length}</p>
                <p><strong>Ingresos Totales:</strong> $${totalIngresos.toLocaleString()}</p>
                <hr>
                <table border="1" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 8px;">N√∫mero</th>
                            <th style="padding: 8px;">Fecha</th>
                            <th style="padding: 8px;">Cliente</th>
                            <th style="padding: 8px;">Concepto</th>
                            <th style="padding: 8px;">Subtotal</th>
                            <th style="padding: 8px;">IVA</th>
                            <th style="padding: 8px;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            facturas.forEach(factura => {
                reporteHTML += `
                    <tr>
                        <td style="padding: 8px;">${factura.number || factura.id || 'N/A'}</td>
                        <td style="padding: 8px;">${factura.date || factura.createdAt || 'N/A'}</td>
                        <td style="padding: 8px;">${factura.clientName || 'N/A'}</td>
                        <td style="padding: 8px;">${factura.concept || factura.description || 'N/A'}</td>
                        <td style="padding: 8px;">$${(factura.subtotal || 0).toLocaleString()}</td>
                        <td style="padding: 8px;">$${(factura.tax || 0).toLocaleString()}</td>
                        <td style="padding: 8px;">$${(factura.total || 0).toLocaleString()}</td>
                    </tr>
                `;
            });

            reporteHTML += `
                    </tbody>
                </table>
            `;

            descargarReporte(reporteHTML, 'reporte-financiero');
            
        } catch (error) {
            console.error('Error generando reporte financiero:', error);
            showVET360Toast('Error', 'No se pudo generar el reporte financiero', 'error');
        }
    }

    // Descargar reporte
    function descargarReporte(contenidoHTML, nombreArchivo) {
        const reporteCompleto = `
            <!DOCTYPE html>
            <html lang="es">
            <head>
                <meta charset="UTF-8">
                <title>Reporte VET360</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    th { background-color: #f8f9fa; }
                    h2 { color: #0d6efd; }
                </style>
            </head>
            <body>
                ${contenidoHTML}
                <hr>
                <p><em>Reporte generado por VET360 - ${new Date().toLocaleString()}</em></p>
            </body>
            </html>
        `;

        const blob = new Blob([reporteCompleto], { type: 'text/html' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        a.href = url;
        a.download = `${nombreArchivo}-${new Date().toISOString().split('T')[0]}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        showVET360Toast('Reporte Generado', 'El reporte se ha descargado correctamente', 'success');
    }

    // Funci√≥n para mostrar notificaciones Toast
    function showVET360Toast(title, message, type = 'info') {
        // Crear el toast si no existe
        let toastContainer = document.getElementById('vet360-toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'vet360-toast-container';
            toastContainer.className = 'position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '9999';
            document.body.appendChild(toastContainer);
        }

        const toastId = 'toast-' + Date.now();
        const iconClass = {
            'success': 'bi-check-circle-fill text-success',
            'error': 'bi-x-circle-fill text-danger',
            'warning': 'bi-exclamation-triangle-fill text-warning',
            'info': 'bi-info-circle-fill text-info'
        };

        const toastHTML = `
            <div id="${toastId}" class="toast" role="alert">
                <div class="toast-header">
                    <i class="bi ${iconClass[type]} me-2"></i>
                    <strong class="me-auto">${title}</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;

        toastContainer.insertAdjacentHTML('beforeend', toastHTML);

        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, {
            autohide: true,
            delay: type === 'error' ? 8000 : 5000
        });

        toast.show();

        // Remover el toast del DOM despu√©s de que se oculte
        toastElement.addEventListener('hidden.bs.toast', function () {
            toastElement.remove();
        });
    }

    // Aplicar per√≠odo r√°pido
    window.aplicarPeriodoRapido = function() {
        const periodo = document.getElementById('periodoRapido').value;
        const ahora = new Date();
        let inicio, fin;

        switch (periodo) {
            case 'hoy':
                inicio = fin = ahora.toISOString().split('T')[0];
                break;
            case 'semana':
                const primerDiaSemana = new Date(ahora);
                primerDiaSemana.setDate(ahora.getDate() - ahora.getDay());
                inicio = primerDiaSemana.toISOString().split('T')[0];
                fin = ahora.toISOString().split('T')[0];
                break;
            case 'mes':
                inicio = new Date(ahora.getFullYear(), ahora.getMonth(), 1).toISOString().split('T')[0];
                fin = new Date(ahora.getFullYear(), ahora.getMonth() + 1, 0).toISOString().split('T')[0];
                break;
            case 'trimestre':
                const trimestre = Math.floor(ahora.getMonth() / 3);
                inicio = new Date(ahora.getFullYear(), trimestre * 3, 1).toISOString().split('T')[0];
                fin = new Date(ahora.getFullYear(), (trimestre + 1) * 3, 0).toISOString().split('T')[0];
                break;
            case 'a√±o':
                inicio = new Date(ahora.getFullYear(), 0, 1).toISOString().split('T')[0];
                fin = new Date(ahora.getFullYear(), 11, 31).toISOString().split('T')[0];
                break;
            default:
                return; // No hacer nada si es personalizado
        }

        document.getElementById('fechaInicio').value = inicio;
        document.getElementById('fechaFin').value = fin;
        
        aplicarFiltros();
    };

    // Aplicar filtros de fecha
    window.aplicarFiltros = function() {
        const fechaInicioInput = document.getElementById('fechaInicio').value;
        const fechaFinInput = document.getElementById('fechaFin').value;

        // Validar fechas
        if (fechaInicioInput && fechaFinInput && fechaInicioInput > fechaFinInput) {
            showVET360Toast('Error de Validaci√≥n', 'La fecha de inicio no puede ser posterior a la fecha de fin', 'error');
            return;
        }

        fechaInicio = fechaInicioInput;
        fechaFin = fechaFinInput;

        // Filtrar datos seg√∫n el per√≠odo
        const citasFiltradas = filtrarPorFecha(allCitas, fechaInicio, fechaFin);
        const facturasFiltradas = filtrarPorFecha(allFacturas, fechaInicio, fechaFin);

        // Actualizar reportes con datos filtrados
        actualizarKPIs(allPacientes, citasFiltradas, facturasFiltradas);
        actualizarTopServicios(citasFiltradas);

        showVET360Toast('Filtros Aplicados', `Datos filtrados del ${fechaInicio || 'inicio'} al ${fechaFin || 'fin'}`, 'success');
    };

    // Filtrar datos por fecha
    function filtrarPorFecha(datos, inicio, fin) {
        if (!inicio && !fin) return datos;

        return datos.filter(item => {
            const fechaItem = item.date || item.createdAt;
            if (!fechaItem) return false;

            const fecha = new Date(fechaItem).toISOString().split('T')[0];
            
            if (inicio && fecha < inicio) return false;
            if (fin && fecha > fin) return false;
            
            return true;
        });
    }

    // Validar campos de fecha
    document.addEventListener('DOMContentLoaded', function() {
        const fechaInicioInput = document.getElementById('fechaInicio');
        const fechaFinInput = document.getElementById('fechaFin');

        if (fechaInicioInput) {
            fechaInicioInput.addEventListener('change', function() {
                const validator = new VET360Validator();
                if (this.value && fechaFinInput.value && this.value > fechaFinInput.value) {
                    validator.showFieldError(this, 'La fecha de inicio no puede ser posterior a la fecha de fin');
                } else {
                    validator.clearFieldError(this);
                }
            });
        }

        if (fechaFinInput) {
            fechaFinInput.addEventListener('change', function() {
                const validator = new VET360Validator();
                if (this.value && fechaInicioInput.value && this.value < fechaInicioInput.value) {
                    validator.showFieldError(this, 'La fecha de fin no puede ser anterior a la fecha de inicio');
                } else {
                    validator.clearFieldError(this);
                }
            });
        }
    });

    // Funci√≥n de carga forzada para casos de emergencia
    window.forzarCarga = function() {
        console.log('üö® Carga forzada activada');
        
        // Simular usuario autenticado
        currentUser = { 
            uid: 'emergency-user', 
            email: 'usuario@vet360.com' 
        };
        
        // Establecer fechas
        establecerFechasPorDefecto();
        
        // Mostrar datos de ejemplo
        mostrarDatosEjemplo();
        
        // Mostrar interfaz
        document.getElementById('authLoading').classList.add('d-none');
        document.getElementById('mainContent').classList.remove('hidden-content');
        
        showVET360Toast('Carga Forzada', 'Reportes cargados en modo de emergencia con datos de ejemplo', 'warning');
        
        console.log('‚úÖ Carga forzada completada');
    };

    // Auto-activar carga forzada despu√©s de 10 segundos si no carga
    setTimeout(() => {
        const loading = document.getElementById('authLoading');
        if (loading && !loading.classList.contains('d-none')) {
            console.log('‚è∞ Timeout: Activando carga forzada autom√°ticamente');
            forzarCarga();
        }
    }, 10000);

</script>

</body>
</html>