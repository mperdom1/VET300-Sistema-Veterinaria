<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurar Admins - Realtime Database - VET360</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/style.css">
    <!-- Sistema de validaciones VET360 -->
    <script src="./js/vet360-validations.js"></script>
</head>
<body class="d-flex align-items-center justify-content-center vh-100">

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8">
            <div class="card p-4">
                <div class="card-body">
                    <div class="text-center mb-4">
                        <img src="./assets/imagenes/logovet360opcion 1.jpg" alt="VET360 Logo" class="logo-img">
                        <h1 class="logo">VET360 ğŸ¾</h1>
                        <h2>Configurar Administradores</h2>
                        <p class="text-muted">Usando Realtime Database</p>
                    </div>
                    
                    <div id="error-message" class="alert alert-danger d-none" role="alert"></div>
                    <div id="success-message" class="alert alert-success d-none" role="alert"></div>
                    <div id="info-message" class="alert alert-info" role="alert">
                        ğŸ”§ Esta pÃ¡gina configura administradores usando Firebase Realtime Database.
                    </div>
                    
                    <form id="setup-form">
                        <h5>ğŸ‘¤ Configurar Administradores</h5>
                        
                        <div class="mb-3">
                            <label class="form-label">Usuario 1 - Michelle Perdomo <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">ğŸ“§</span>
                                <input type="email" class="form-control" id="email1" value="mperdomo591@gmail.com" required 
                                       maxlength="100" title="Email del Usuario 1" readonly>
                                <span class="input-group-text">ğŸ”‘</span>
                                <input type="password" class="form-control" id="password1" placeholder="ContraseÃ±a (min. 6 caracteres)" 
                                       required minlength="6" maxlength="50" title="ContraseÃ±a debe tener al menos 6 caracteres">
                            </div>
                            <div class="form-text">La contraseÃ±a debe tener al menos 6 caracteres con letras y nÃºmeros</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Usuario 2 - JosÃ© Luis DomÃ­nguez <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">ğŸ“§</span>
                                <input type="email" class="form-control" id="email2" value="10luisdominguez@gmail.com" required 
                                       maxlength="100" title="Email del Usuario 2" readonly>
                                <span class="input-group-text">ğŸ”‘</span>
                                <input type="password" class="form-control" id="password2" placeholder="ContraseÃ±a (min. 6 caracteres)" 
                                       required minlength="6" maxlength="50" title="ContraseÃ±a debe tener al menos 6 caracteres">
                            </div>
                            <div class="form-text">La contraseÃ±a debe tener al menos 6 caracteres con letras y nÃºmeros</div>
                        </div>
                        
                        <div class="alert alert-warning">
                            âš ï¸ <strong>Importante:</strong> Necesitas las contraseÃ±as para validar y crear los perfiles.
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="setup-btn">
                                <span class="btn-text">Crear Administradores</span>
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            </button>
                        </div>
                    </form>
                    
                    <div id="success-panel" class="d-none mt-4">
                        <div class="alert alert-success">
                            <h5>âœ… Â¡ConfiguraciÃ³n completada!</h5>
                            <p>Los administradores han sido configurados exitosamente en Realtime Database.</p>
                            <hr>
                            <p class="mb-0">
                                <strong>PrÃ³ximos pasos:</strong>
                                <br>1. Ir a la pÃ¡gina de <a href="login.html" class="btn btn-sm btn-primary">Login</a>
                                <br>2. Iniciar sesiÃ³n con cualquiera de las cuentas
                                <br>3. Acceder al dashboard de administrador
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Firebase SDK v12.5.0 (modular) -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js';
    import { getDatabase, ref, set } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js';
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js';

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBZoyZqhODCH90zcPdY_iT8mhh2S-X5FRE",
        authDomain: "vet360-d262a.firebaseapp.com",
        databaseURL: "https://vet360-d262a-default-rtdb.firebaseio.com",
        projectId: "vet360-d262a",
        storageBucket: "vet360-d262a.firebasestorage.app",
        messagingSenderId: "184009559961",
        appId: "1:184009559961:web:12b1311b6224a5d58ecd08",
        measurementId: "G-5K02J1Z7VZ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);
    const analytics = getAnalytics(app);

    // UI elements
    const setupForm = document.getElementById('setup-form');
    const setupBtn = document.getElementById('setup-btn');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');
    const infoMessage = document.getElementById('info-message');
    const successPanel = document.getElementById('success-panel');

    let completedUsers = 0;

    // Admin permissions (full access)
    const ADMIN_PERMISSIONS = [
        'full_access',
        'manage_users',
        'create_users',
        'edit_users',
        'delete_users',
        'view_reports',
        'system_settings',
        'manage_billing',
        'view_patients',
        'create_patients',
        'edit_patients',
        'delete_patients',
        'view_appointments',
        'create_appointments',
        'edit_appointments',
        'delete_appointments',
        'view_medical_records',
        'create_medical_records',
        'edit_medical_records'
    ];

    // User data
    const users = [
        {
            email: 'mperdomo591@gmail.com',
            firstName: 'Michelle',
            lastName: 'Perdomo',
            employeeId: 'VET360-ADMIN-001'
        },
        {
            email: '10luisdominguez@gmail.com',
            firstName: 'Luis',
            lastName: 'DomÃ­nguez',
            employeeId: 'VET360-ADMIN-002'
        }
    ];

    // Show/hide elements
    function showElement(element) {
        element.classList.remove('d-none');
    }

    function hideElement(element) {
        element.classList.add('d-none');
    }

    // Show loading state
    function showLoading(show) {
        const btnText = setupBtn.querySelector('.btn-text');
        const spinner = setupBtn.querySelector('.spinner-border');
        
        if (show) {
            btnText.textContent = 'Configurando...';
            showElement(spinner);
            setupBtn.disabled = true;
        } else {
            btnText.textContent = 'Crear Administradores';
            hideElement(spinner);
            setupBtn.disabled = false;
        }
    }

    // Show messages
    function showError(message) {
        errorMessage.textContent = message;
        showElement(errorMessage);
        hideElement(successMessage);
    }

    function showSuccess(message) {
        successMessage.textContent = message;
        showElement(successMessage);
        hideElement(errorMessage);
    }

    function hideMessages() {
        hideElement(errorMessage);
        hideElement(successMessage);
    }

    // Create admin profile in Realtime Database
    async function createAdminProfile(email, password, userData) {
        try {
            console.log('Authenticating user:', email);
            
            // Authenticate user to get UID
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            
            console.log('User authenticated, UID:', user.uid);
            
            // Create admin profile in Realtime Database
            const adminProfile = {
                uid: user.uid,
                email: email,
                firstName: userData.firstName,
                lastName: userData.lastName,
                role: 'admin',
                department: 'administracion',
                employeeId: userData.employeeId,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                requirePasswordChange: false,
                isActive: true,
                permissions: ADMIN_PERMISSIONS,
                isConfigured: true,
                profileCompleted: true,
                isDefaultAdmin: true,
                lastLogin: new Date().toISOString()
            };

            console.log('Saving profile to Realtime Database...');
            
            // Save to Realtime Database
            await set(ref(database, 'users/' + user.uid), adminProfile);
            
            console.log('Profile saved successfully');
            
            // Sign out to allow next user
            await signOut(auth);
            
            return true;
        } catch (error) {
            console.error('Error creating admin profile:', error);
            throw error;
        }
    }

    // Process both users
    async function setupAdmins(email1, password1, email2, password2) {
        showLoading(true);
        hideMessages();

        try {
            console.log('Starting admin setup...');
            
            // Setup user 1
            await createAdminProfile(email1, password1, users[0]);
            showSuccess('âœ… Usuario 1 configurado exitosamente...');
            
            // Wait a bit before next user
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Setup user 2
            await createAdminProfile(email2, password2, users[1]);
            showSuccess('âœ… Ambos administradores configurados exitosamente!');
            
            // Show success panel
            setTimeout(() => {
                hideElement(setupForm);
                hideElement(infoMessage);
                showElement(successPanel);
            }, 2000);

        } catch (error) {
            console.error('Error in admin setup:', error);
            
            let errorMsg = 'ğŸš¨ Error desconocido. Verifica los datos.';
            
            switch (error.code) {
                case 'auth/user-not-found':
                    errorMsg = 'âŒ Usuario no encontrado. Verifica el correo electrÃ³nico.';
                    break;
                case 'auth/wrong-password':
                    errorMsg = 'âŒ ContraseÃ±a incorrecta. Verifica las contraseÃ±as.';
                    break;
                case 'auth/invalid-email':
                    errorMsg = 'âŒ Formato de correo incorrecto.';
                    break;
                case 'auth/network-request-failed':
                    errorMsg = 'ğŸŒ Error de conexiÃ³n. Verifica tu internet.';
                    break;
                case 'auth/too-many-requests':
                    errorMsg = 'âš ï¸ Demasiados intentos. Espera unos minutos.';
                    break;
                case 'PERMISSION_DENIED':
                    errorMsg = 'ğŸš« Error de permisos en Realtime Database. Verifica las reglas.';
                    break;
                default:
                    errorMsg = `ğŸš¨ Error: ${error.code || error.message}`;
                    break;
            }
            
            showError(errorMsg);
        } finally {
            showLoading(false);
        }
    }

    // Form submission
    setupForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const email1 = document.getElementById('email1').value.trim();
        const password1 = document.getElementById('password1').value;
        const email2 = document.getElementById('email2').value.trim();
        const password2 = document.getElementById('password2').value;

        // ValidaciÃ³n usando VET360Validator
        vet360Validator.clearErrors();
        
        let isValid = true;
        
        // Validar Usuario 1
        if (!vet360Validator.validateEmail(email1)) isValid = false;
        if (!vet360Validator.validatePassword(password1)) isValid = false;
        
        // Validar Usuario 2  
        if (!vet360Validator.validateEmail(email2)) isValid = false;
        if (!vet360Validator.validatePassword(password2)) isValid = false;
        
        if (!isValid) {
            const errors = vet360Validator.getErrors();
            const errorMessages = errors.map(e => e.message).join(', ');
            showError(`âŒ Errores de validaciÃ³n: ${errorMessages}`);
            return;
        }

        setupAdmins(email1, password1, email2, password2);
    });
</script>

</body>
</html>